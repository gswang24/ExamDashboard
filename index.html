<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Áõ£ËÄÉÂÑÄË°®Êùø v0115.4 (ÂñÆ‰∏ÄÈéñÂÆöÁâà)</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîí</text></svg>">

    <style>
        :root {
            --c-grey:   #231F20;
            --c-red:    #BB4430;
            --c-teal:   #7EBDC2;
            --c-yellow: #F3DFA2;
            --c-linen:  #EFE6DD;
            --c-green:  #70A9A1;
            --bg-body:  #f0f0f0;
            --clock-bg: #333;
            --clock-text:#f0f0f0;
            --gap-size: 14px;
        }

        /* --- Âü∫Á§éË®≠ÂÆö --- */
        ::view-transition-group(*) { 
            animation-duration: 0.3s; 
            animation-timing-function: cubic-bezier(0.2, 0, 0.2, 1);
        }
        body.no-transition * { view-transition-name: none !important; }
        .col-label-input, .podium { view-transition-name: none !important; }

        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-touch-callout: none; 
            -webkit-user-select: none;
            user-select: none;
        }
        input, textarea { 
            -webkit-user-select: text !important; 
            user-select: text !important; 
            cursor: text;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            margin: 0; 
            padding: 10px 15px calc(15px + env(safe-area-inset-bottom)) 15px;
            height: 100vh; height: 100dvh; 
            display: flex; flex-direction: column;
            overflow: hidden; color: var(--c-grey);
            position: fixed; width: 100%;
        }

        body:fullscreen { padding: 0; background-color: var(--c-grey); }
        body:fullscreen .clock-card, body:fullscreen .status-card,
        body:fullscreen .subject-list, body:fullscreen .attendance-card,
        body:fullscreen .seating-container { border-radius: 0; border-width: 0 1px 1px 0; }

        #fullscreenBtn {
            position: fixed; top: 10px; right: 10px; z-index: 3000;
            background-color: rgba(35, 31, 32, 0.8); color: #fff;
            border: none; border-radius: 6px; padding: 6px 10px;
            cursor: pointer; font-weight: bold; font-size: 0.8rem;
            transition: 0.2s; backdrop-filter: blur(2px);
        }
        #fullscreenBtn:hover { transform: scale(1.05); background-color: #000; }
        body:fullscreen #fullscreenBtn { opacity: 0.3; }

        .version-tag {
            position: fixed; top: 12px; left: 15px; z-index: 3000;
            color: var(--c-grey); font-weight: 900; font-size: 0.9rem;
            opacity: 0.4; pointer-events: none;
            font-family: 'Courier New', monospace; display: none;
        }

        /* --- Resizer --- */
        .resizer { z-index: 100; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background-color: transparent; touch-action: none; transition: background-color 0.2s; }
        .resizer:hover { background-color: rgba(0,0,0,0.05); border-radius: 4px; }
        .resizer-v { width: var(--gap-size); cursor: col-resize; height: 100%; }
        .resizer-h { height: var(--gap-size); cursor: row-resize; width: 100%; }
        body.is-resizing * { pointer-events: none; } 

        .header-row { display: flex; height: 170px; min-height: 80px; flex-shrink: 0; }

        /* --- Clock & Status --- */
        .clock-card {
            background-color: var(--c-yellow); color: var(--c-grey);
            border: 2px solid var(--c-grey); border-radius: 16px; padding: 8px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            flex: 1; min-width: 220px; box-shadow: 4px 4px 0px rgba(35, 31, 32, 0.15);
            overflow: hidden; position: relative;
        }
        .clock-label { font-size: 1.8rem; font-weight: bold; opacity: 0.8; letter-spacing: 2px; margin-bottom: 2px; white-space: nowrap; }
        .clock-date { font-size: 1rem; font-weight: bold; opacity: 0.7; margin-bottom: 5px; white-space: nowrap; }
        .flip-clock-container { display: flex; gap: 8px; align-items: center; justify-content: center; }
        
        .flip-unit {
            position: relative; width: 90px; height: 70px; perspective: 400px;
            background-color: var(--clock-bg); border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); font-family: 'Courier New', monospace;
            font-weight: 800; font-size: 3.5rem; line-height: 70px; color: var(--clock-text); text-align: center;
        }
        .flip-top, .flip-bottom { position: absolute; left: 0; width: 100%; height: 50%; overflow: hidden; background-color: var(--clock-bg); }
        .flip-top { top: 0; border-radius: 6px 6px 0 0; z-index: 1; border-bottom: 1px solid rgba(0,0,0,0.3); }
        .flip-bottom { bottom: 0; border-radius: 0 0 6px 6px; z-index: 0; }
        .flip-top span, .flip-bottom span { position: absolute; left: 0; width: 100%; height: 200%; display: flex; justify-content: center; align-items: center; }
        .flip-top span { top: 0; } .flip-bottom span { top: -100%; }
        
        .flip-leaf-front, .flip-leaf-back { position: absolute; left: 0; width: 100%; height: 50%; overflow: hidden; backface-visibility: hidden; background-color: var(--clock-bg); }
        .flip-leaf-front { top: 0; border-radius: 6px 6px 0 0; transform-origin: 50% 100%; z-index: 2; border-bottom: 1px solid rgba(0,0,0,0.3); }
        .flip-leaf-back { top: 50%; border-radius: 0 0 6px 6px; transform-origin: 50% 0%; z-index: 2; transform: rotateX(180deg); }
        .flip-leaf-front span, .flip-leaf-back span { position: absolute; left: 0; width: 100%; height: 200%; display: flex; justify-content: center; align-items: center; }
        .flip-leaf-front span { top: 0; } .flip-leaf-back span { top: -100%; }
        .flip-unit.flipping .flip-leaf-front { animation: flipDownFront 0.4s ease-in-out forwards; } 
        .flip-unit.flipping .flip-leaf-back { animation: flipDownBack 0.4s ease-in-out forwards; } 
        @keyframes flipDownFront { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(-180deg); } }
        @keyframes flipDownBack { 0% { transform: rotateX(180deg); } 100% { transform: rotateX(0deg); } }
        .flip-sep { font-size: 3rem; font-weight: 800; padding-bottom: 10px; line-height: 1; }

        .status-card {
            flex: 5; background-color: var(--c-grey); color: var(--c-linen);
            border-radius: 16px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; position: relative;
            overflow: hidden; min-width: 200px; border: 2px solid var(--c-grey);
            box-shadow: 4px 4px 0px rgba(0,0,0,0.15); 
        }
        .status-label { font-size: 1.8rem; color: #ccc; margin-bottom: 2px; z-index: 2; letter-spacing: 2px; font-weight: bold; }
        .status-time { font-size: 5rem; font-weight: bold; z-index: 2; font-family: 'Courier New', monospace; line-height: 1; color: var(--c-teal); }
        .status-sub { font-size: 1.2rem; color: #fff; z-index: 2; margin-top: 5px; font-weight: bold; }
        .status-card.urgent .status-time { color: var(--c-red); }
        .progress-bg { position: absolute; left: 0; bottom: 0; top: 0; width: 0%; background-color: rgba(243, 223, 162, 0.5); transition: width 1s linear; z-index: 1; }

        .header-row.compact .clock-card, .header-row.compact .status-card { padding: 4px; }
        .header-row.compact .clock-label { font-size: 1.2rem; margin-bottom: 2px; }
        .header-row.compact .clock-date { display: none; }
        .header-row.compact .flip-unit { width: 60px; height: 50px; font-size: 2.0rem; line-height: 50px; }
        .header-row.compact .flip-sep { font-size: 2rem; padding-bottom: 5px; }
        .header-row.compact .status-label { font-size: 1.2rem; margin-bottom: 0; }
        .header-row.compact .status-time { font-size: 3.5rem; }

        .content-row { display: flex; flex: 1; overflow: hidden; height: 100%; position: relative; min-height: 0; }
        
        .schedule-column { flex: 1; min-width: 250px; display: flex; flex-direction: column; height: 100%; }
        
        .subject-list { 
            background-color: var(--c-teal); border: 2px solid var(--c-grey);
            border-radius: 16px; padding: 12px; overflow-y: auto; 
            box-shadow: 4px 4px 0px rgba(35, 31, 32, 0.15);
            display: flex; flex-direction: column; gap: 8px; flex-grow: 1; 
        }
        .subject-item { 
            display: flex; flex-direction: column; padding: 10px; 
            border-radius: 8px; gap: 4px; background: #fff; 
            border: 2px solid transparent; box-shadow: 2px 2px 0px rgba(0,0,0,0.05);
            flex-shrink: 0; 
        }
        .subject-item.active { border: 2px solid var(--c-grey); background-color: var(--c-yellow); transform: scale(1.02); }
        .subject-header { display: flex; justify-content: space-between; align-items: center; }
        .subject-input { font-size: 1.3rem; font-weight: 800; border: none; outline: none; background: transparent; width: 80%; color: var(--c-grey); padding: 5px 0; }
        .time-inputs { display: flex; align-items: center; gap: 5px; }
        .time-input { 
            border: 1px solid #ddd; border-radius: 4px; padding: 5px; 
            font-size: 1.2rem; font-weight: bold; width: 100%; text-align: center; 
            color: var(--c-grey); background: #f9f9f9; font-family: 'Courier New', monospace;
        }

        .attendance-card { 
            background-color: var(--c-grey); border: 2px solid var(--c-grey);
            border-radius: 16px; height: 160px; min-height: 60px;
            flex-shrink: 0; display: flex; overflow: hidden; 
            box-shadow: 4px 4px 0px rgba(35, 31, 32, 0.15);
            padding: 5px; gap: 5px; container-type: inline-size;
        }
        .att-box { 
            flex: 1; display: flex; flex-direction: column; padding: 8px;
            border-radius: 10px; border: 2px solid rgba(255,255,255,0.1); 
            background: rgba(255, 255, 255, 0.05); overflow: hidden;
        }
        .att-box:nth-child(1) { border-color: var(--c-teal); background: rgba(126, 189, 194, 0.1); }
        .att-box:nth-child(1) .att-val { color: var(--c-teal); }
        .att-box:nth-child(2) { border-color: var(--c-yellow); background: rgba(243, 223, 162, 0.1); }
        .att-box:nth-child(2) .att-val { color: var(--c-yellow); }
        .att-box:nth-child(3) { flex: 1.8; border-color: var(--c-red); background: rgba(187, 68, 48, 0.1); }
        
        .att-label { font-size: 1.1rem; font-weight: 900; color: #ccc; margin: 0; line-height: 1; flex-shrink: 0; }
        .att-val { 
            font-size: clamp(2rem, 11cqi, 4.5rem); font-weight: 800; background: transparent; 
            border: none; text-align: center; outline: none; width: 100%; 
            margin: auto 0; padding: 0; line-height: 1;
        }
        textarea.att-val { 
            resize: none; height: auto; flex-grow: 1; width: 100%;
            font-size: clamp(1rem, 5cqi, 1.3rem); line-height: 1.4; 
            border: 2px dashed rgba(187, 68, 48, 0.5); border-radius: 8px; 
            margin-top: 5px; padding: 5px 8px; color: #ff5252; font-weight: bold;
            background: rgba(0,0,0,0.2); text-align: left;
        }

        .attendance-card.compact .att-label { font-size: 0.9rem; }
        .attendance-card.compact .att-val { font-size: clamp(1.5rem, 10cqi, 3.5rem); }

        /* --- Seating --- */
        .seating-container {
            flex: 3.5; background-color: var(--c-linen);
            border: 2px solid var(--c-grey); border-radius: 16px;
            box-shadow: 4px 4px 0px rgba(35, 31, 32, 0.15); padding: 8px;
            display: flex; flex-direction: column; position: relative; min-width: 0; overflow: hidden; 
        }

        .seating-toolbar { 
            display: flex; justify-content: space-between; margin-bottom: 5px;
            align-items: center; flex-wrap: wrap; gap: 5px; flex-shrink: 0; 
        }

        .view-control-group {
            display: flex; align-items: center; gap: 8px; 
            margin-left: auto; margin-right: 10px;
            background: rgba(255,255,255,0.5); padding: 4px 10px; border-radius: 20px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .view-label { font-size: 0.9rem; font-weight: bold; color: var(--c-grey); cursor: pointer; }
        
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #999; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--c-teal); }
        input:checked + .slider:before { transform: translateX(20px); }

        .btn { 
            padding: 6px 12px; border-radius: 8px; border: 2px solid var(--c-grey); 
            cursor: pointer; font-weight: bold; font-size: 0.95rem; white-space: nowrap; 
            transition: 0.1s; box-shadow: 2px 2px 0px rgba(0,0,0,0.1); 
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: none; }
        .btn-main { background: var(--c-grey); color: #fff; }
        .btn-sec { background: #fff; color: var(--c-grey); }
        .btn-red { background: var(--c-red); color: #fff; }
        .btn-green { background: var(--c-green); color: #fff; }
        .btn-tiny { font-size: 0.8rem; padding: 4px 8px; background: #fff; opacity: 0.9; }

        /* DISABLED STATE for buttons */
        .btn.disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(1);
            background: #e0e0e0; color: #999; border-color: #ccc;
            box-shadow: none;
        }

        .classroom-layout {
            flex: 1; display: flex; flex-direction: row; flex-wrap: nowrap; 
            justify-content: center; align-items: stretch; gap: 4px; padding-bottom: 5px;
            overflow: auto; width: 100%; -webkit-overflow-scrolling: touch; order: 1; 
        }
        
        .seat-column { 
            display: flex; flex-direction: column; gap: 4px; align-items: center; 
            flex: 1; min-width: 60px; height: 100%; 
        }
        .col-label-input { 
            flex: 0 0 auto; margin-top: 5px; width: 100%; text-align: center; 
            background: transparent; border: 1px solid transparent; border-radius: 4px; 
            font-weight: 800; color: var(--c-grey); font-size: 0.9rem; opacity: 0.7; 
            pointer-events: none; 
        }
        .seating-container.student-view .col-label-input { order: -1; margin-top: 0; margin-bottom: 5px; }

        .seat-box {
            width: 100%; flex: 1 1 0%; min-height: 0; 
            border: 2px solid var(--c-grey); border-radius: 6px; display: flex; background: #fff;
            position: relative; cursor: grab; box-shadow: 2px 2px 0px rgba(0,0,0,0.05);
            overflow: hidden; touch-action: none; container-type: size;
        }
        
        /* LOCKED STATE CSS */
        .seating-container.locked .seat-box { cursor: default; }
        .seating-container.locked .seat-close { display: none !important; }
        .seating-container.locked .seat-box:active { cursor: default; transform: none; }
        .seating-container.locked .seat-box.empty { cursor: default; opacity: 0.5; border-style: dotted; }
        .seating-container.locked .seat-box.empty:hover { background: rgba(255,255,255,0.4); }

        .seat-box:active { cursor: grabbing; transform: scale(0.98); }
        .seat-ghost { position: fixed; z-index: 9999; pointer-events: none; opacity: 0.8; box-shadow: 4px 4px 10px rgba(0,0,0,0.2); transform: scale(1.05) rotate(2deg); background: #fff; border: 2px solid var(--c-teal); }
        .seat-box.drag-over { background-color: var(--c-teal); border-color: var(--c-grey); color: #fff; }
        .seat-box.empty { border: 2px dashed #bbb; background-color: rgba(255,255,255,0.4); color: #999; justify-content: center; align-items: center; cursor: pointer; box-shadow: none; }
        .add-sign { font-size: 2rem; font-weight: bold; pointer-events: none; }
        
        .seat-num { width: 25px; min-width: 20px; border-right: 2px solid var(--c-grey); display: flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: 900; background: var(--c-yellow); color: var(--c-grey); flex-shrink: 0; pointer-events: none; }
        .seat-name { 
            flex: 1; display: flex; align-items: center; justify-content: center; 
            font-size: clamp(0.8rem, min(24cqw, 50cqh), 3.5rem); 
            font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            pointer-events: none; padding: 0 2px; line-height: 1.1;
        }
        .seat-close { position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: var(--c-red); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; cursor: pointer; opacity: 0; transition: 0.2s; z-index: 5; border: 1px solid #fff; }
        .seat-box:hover .seat-close { opacity: 1; }

        .podium {
            width: 180px; height: 35px; border: 3px solid var(--c-grey); 
            background: var(--c-grey); color: #fff; display: flex; align-items: center; justify-content: center;
            font-weight: 900; letter-spacing: 5px; pointer-events: none; border-radius: 8px;
            margin: 5px 0; align-self: center; order: 2; z-index: 10; font-size: 0.9rem;
        }
        .seating-container.student-view .podium { order: 0; margin-bottom: 10px; }

        .modal-overlay { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(35, 31, 32, 0.7); display: none; 
            align-items: flex-start; padding-top: 50px; overflow-y: auto;        
            z-index: 10000; backdrop-filter: blur(2px); -webkit-overflow-scrolling: touch; 
        }
        .modal { 
            background: #fff; padding: 25px; border-radius: 16px; width: 450px; 
            border: 4px solid var(--c-grey); box-shadow: 8px 8px 0px var(--c-yellow); 
            margin: 0 auto 50vh auto; flex-shrink: 0; max-width: 90%;
        }
        .modal h3 { margin-top: 0; color: var(--c-grey); }
        .modal input[type="text"], .modal input[type="password"], .modal textarea { width: 100%; margin: 5px 0 15px 0; padding: 10px; border: 2px solid var(--c-grey); border-radius: 8px; font-size: 1rem; }
        .modal textarea { height: 200px; }
        .modal-footer { text-align: right; gap: 15px; display: flex; justify-content: flex-end; }
        .btn-delete { background: none; border: none; color: #ccc; font-size: 1.5rem; cursor: pointer; }
        .btn-delete:hover { color: var(--c-red); transform: scale(1.2); }
        
        #addSubjectBtn { width: 100%; border-style: dashed; background: rgba(255,255,255,0.5); margin-top: auto; }
    </style>
</head>
<body class="no-transition">

    <div class="version-tag">v0115.4</div>
    <button id="fullscreenBtn" onclick="toggleFullscreen()">‚õ∂ ÂÖ®Ëû¢Âπï</button>

    <div class="header-row" id="headerRow">
        <div class="clock-card" id="clockCard">
            <div class="clock-label">ÁõÆÂâçÊôÇÈñì</div>
            <div class="clock-date" id="clockDate">--/--</div>
            <div class="flip-clock-container">
                <div class="flip-unit" id="flipH"><div class="flip-top"><span>00</span></div><div class="flip-bottom"><span>00</span></div></div>
                <div class="flip-sep">:</div>
                <div class="flip-unit" id="flipM"><div class="flip-top"><span>00</span></div><div class="flip-bottom"><span>00</span></div></div>
            </div>
        </div>
        <div class="resizer resizer-v" id="resizerHeader"></div>
        <div class="status-card" id="statusCard">
            <div class="progress-bg" id="progressFill"></div>
            <div class="status-label">Ââ©È§òÊôÇÈñì</div>
            <div class="status-time" id="remainingTime">--:--</div>
            <div class="status-sub" id="statusText">Á≠âÂæÖ‰∏≠</div>
        </div>
    </div>

    <div class="resizer resizer-h" id="resizerMain"></div>

    <div class="content-row">
        <div class="schedule-column" id="scheduleCol">
            <div class="subject-list" id="subjectList">
                <button id="addSubjectBtn" class="btn btn-tiny" onclick="addSubject()">+ Êñ∞Â¢ûÁßëÁõÆ</button>
            </div>
            <div class="resizer resizer-h" id="resizerSubjectSplit"></div>
            <div class="attendance-card" id="attendanceCard">
                <div class="att-box"><div class="att-label">ÊáâÂà∞</div><input type="number" class="att-val" value="0"></div>
                <div class="att-box"><div class="att-label">ÂØ¶Âà∞</div><input type="number" class="att-val" value="0"></div>
                <div class="att-box"><div class="att-label">Êú™Âà∞ËôüÁ¢º</div><textarea class="att-val" placeholder="ÁÑ°"></textarea></div>
            </div>
        </div>

        <div class="resizer resizer-v" id="resizerContent"></div>

        <div class="seating-container locked" id="seatingContainer">
            <div class="seating-toolbar">
                <div style="display:flex; gap:5px;" id="gridControls">
                    <button class="btn btn-tiny" onclick="addColumn()">+ Â¢ûÊéí</button>
                    <button class="btn btn-tiny" onclick="removeColumn()">- Âà™Êéí</button>
                    <button class="btn btn-tiny" onclick="addRow()">+ Â¢ûÂàó</button>
                    <button class="btn btn-tiny" onclick="removeRow()">- Âà™Âàó</button>
                </div>
                
                <div class="view-control-group">
                    <span class="view-label" onclick="setDirection(false)">Â∑¶Ëµ∑</span>
                    <label class="switch"><input type="checkbox" id="dirToggle"><span class="slider"></span></label>
                    <span class="view-label" onclick="setDirection(true)">Âè≥Ëµ∑</span>
                    <div style="width:1px; height:20px; background:#ccc; margin:0 10px;"></div>
                    <span class="view-label" onclick="setView(false)">ËÄÅÂ∏´</span>
                    <label class="switch"><input type="checkbox" id="viewToggle"><span class="slider"></span></label>
                    <span class="view-label" onclick="setView(true)">Â≠∏Áîü</span>
                </div>

                <div style="display:flex; gap:5px;">
                    <button class="btn btn-red" id="masterLockBtn" onclick="toggleMasterLock()">üîí ÈéñÂÆö</button>
                    <button class="btn btn-sec disabled" id="btnList" onclick="openModal()">üìã ÂêçÂñÆ</button>
                    <button class="btn btn-main disabled" id="btnShuffle" onclick="reshuffleSeating()">üîÑ ÈáçÊéí</button>
                    <button class="btn btn-red disabled" id="btnReset" onclick="performReset()">‚ö†Ô∏è ÈáçÁΩÆ</button>
                </div>
            </div>

            <div class="classroom-layout" id="classroomLayout"></div>
            <div class="podium">Ë¨õËá∫</div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal">
            <h3>Á∑®ËºØÂ≠∏ÁîüÂêçÂñÆ</h3>
            <p style="color:var(--c-grey); font-size:0.9rem;">Ê†ºÂºèÔºö„ÄåÂ∫ßËôü ÂßìÂêç„ÄçÊàñÂÉÖ„ÄåÂßìÂêç„Äç</p>
            <textarea id="studentListInput" onfocus="this.select()"></textarea>
            <div class="modal-footer">
                <button class="btn btn-sec" onclick="closeModal()">ÂèñÊ∂à</button>
                <button class="btn btn-main" onclick="saveStudents()">Á¢∫Ë™ç</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="singleStudentModal">
        <div class="modal" style="width: 320px;">
            <h3>Êñ∞Â¢ûÂ≠∏Áîü</h3>
            <div style="margin-bottom: 10px;">
                <label style="display:block;margin-bottom:5px;font-weight:bold;">Â∫ßËôü</label>
                <input type="text" id="newStudentId" class="modal-input" placeholder="1">
            </div>
            <div>
                <label style="display:block;margin-bottom:5px;font-weight:bold;">ÂßìÂêç</label>
                <input type="text" id="newStudentName" class="modal-input" placeholder="ÁéãÂ∞èÊòé">
            </div>
            <div class="modal-footer">
                <button class="btn btn-sec" onclick="closeSingleStudentModal()">ÂèñÊ∂à</button>
                <button class="btn btn-main" onclick="confirmAddStudent()">Á¢∫Ë™ç</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="passwordModal">
        <div class="modal" style="width: 300px; text-align: center;">
            <h3>üîì Ëß£ÈéñÁ∑®ËºØ</h3>
            <p style="color:var(--c-grey); font-size:0.9rem; margin-bottom:15px;">Ë´ãËº∏ÂÖ•ÁÆ°ÁêÜÂì°ÂØÜÁ¢º</p>
            
            <input type="password" inputmode="numeric" pattern="[0-9]*" id="adminPasswordInput" class="modal-input" placeholder="ÂØÜÁ¢º" style="text-align:center; font-size:1.5rem; letter-spacing: 5px;">
            
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn btn-sec" onclick="closePasswordModal()">ÂèñÊ∂à</button>
                <button class="btn btn-main" onclick="checkPassword()">Á¢∫Ë™ç</button>
            </div>
        </div>
    </div>

    <script>
        const SAVE_KEY = 'dashboard_v0115_4_data';
        const MASTER_PASSWORD = "1013"; 
        
        let isLocked = true; // Áµ±‰∏ÄÈéñÂÆöÁãÄÊÖã
        let students = [{id:"1",name:"ÁéãÂ¶çÂøÉ"},{id:"2",name:"ÊùéÂ§ßËèØ"},{id:"3",name:"ÂºµÂ∞èÊòé"},{id:"4",name:"Èô≥ÈòøÂØ∂"},{id:"5",name:"ÊûóÂøóË±™"},{id:"6",name:"Ë®±ÂÆ∂Ë±™"}];

        function saveToLocal() {
            const subjects = [];
            document.querySelectorAll('.subject-item').forEach(item => {
                subjects.push({
                    name: item.querySelector('.subject-input').value,
                    start: item.querySelector('.time-start').value,
                    end: item.querySelector('.time-end').value
                });
            });
            const attInputs = document.querySelectorAll('.att-val');
            const data = {
                students: students,
                subjects: subjects,
                attendance: { expected: attInputs[0].value, actual: attInputs[1].value, missing: attInputs[2].value },
                settings: { isStudentView: document.getElementById('viewToggle').checked, isRightStart: document.getElementById('dirToggle').checked },
                grid: getGridFromDOM().map(col => ({ label: col.label, seats: col.seats.map(s => s ? {id:s.id, name:s.name} : null) }))
            };
            localStorage.setItem(SAVE_KEY, JSON.stringify(data));
        }

        function loadFromLocal() {
            const raw = localStorage.getItem(SAVE_KEY);
            if (raw) {
                try {
                    const data = JSON.parse(raw);
                    document.getElementById('viewToggle').checked = data.settings?.isStudentView || false;
                    document.getElementById('dirToggle').checked = data.settings?.isRightStart || false;
                    if(data.settings?.isStudentView) document.getElementById('seatingContainer').classList.add('student-view');

                    if (data.grid) { renderGridToDOM(data.grid); updateStudentsFromDOM(); }
                    else if (data.students) { students = data.students; refillSeating(students); }
                    else generateSeatingInitial();

                    if (data.subjects) {
                        const list = document.getElementById('subjectList');
                        list.innerHTML = '<button id="addSubjectBtn" class="btn btn-tiny" onclick="addSubject()">+ Êñ∞Â¢ûÁßëÁõÆ</button>';
                        const btn = document.getElementById('addSubjectBtn');
                        data.subjects.forEach(sub => {
                            const d = createSubjectEl(sub.name, sub.start, sub.end);
                            list.insertBefore(d, btn);
                        });
                    } else { addDefaultSubjects(); }

                    if (data.attendance) {
                        const att = document.querySelectorAll('.att-val');
                        att[0].value = data.attendance.expected; att[1].value = data.attendance.actual; att[2].value = data.attendance.missing;
                    }
                } catch(e) { console.error(e); generateSeatingInitial(); addDefaultSubjects(); }
            } else { generateSeatingInitial(); addDefaultSubjects(); }
            
            updateLockUI(); // ÂàùÂßãÂåñ‰ªãÈù¢ÈéñÂÆöÁãÄÊÖã
            setTimeout(() => document.body.classList.remove('no-transition'), 100);
        }

        function addDefaultSubjects(){
            const list = document.getElementById('subjectList');
            const btn = document.getElementById('addSubjectBtn');
            list.insertBefore(createSubjectEl('ÁîüÁâ©','13:20','14:10'), btn);
            list.insertBefore(createSubjectEl('ÁêÜÂåñ','14:20','15:10'), btn);
        }

        function createSubjectEl(name, start, end) {
            const d = document.createElement('div'); d.className = 'subject-item';
            d.innerHTML = `<div class="subject-header"><input type="text" class="subject-input" value="${name}" onfocus="handleFocus(this)"><button class="btn-delete" onclick="removeSubject(this)">√ó</button></div><div class="time-inputs"><input type="text" class="time-input time-start" value="${start}" maxlength="5" onfocus="handleFocus(this)" onblur="formatTimeInput(this)"><span class="time-sep">~</span><input type="text" class="time-input time-end" value="${end}" maxlength="5" onfocus="handleFocus(this)" onblur="formatTimeInput(this)"></div>`;
            return d;
        }

        window.addEventListener('load', loadFromLocal);
        document.body.addEventListener('input', () => setTimeout(saveToLocal, 1000));

        // --- LOCK LOGIC ---
        function toggleMasterLock() {
            if (isLocked) {
                // Â¶ÇÊûúÁõÆÂâçÊòØÈéñÂÆöÔºåÂâáÈñãÂïüÂØÜÁ¢ºË¶ñÁ™ó
                openPasswordModal();
            } else {
                // Â¶ÇÊûúÁõÆÂâçÊòØËß£ÈéñÔºåÂâáÁõ¥Êé•ÈéñÂÆö (‰∏çÈúÄË¶ÅÂØÜÁ¢º)
                isLocked = true;
                updateLockUI();
            }
        }

        function checkPassword() {
            const input = document.getElementById('adminPasswordInput');
            if (input.value === MASTER_PASSWORD) {
                isLocked = false;
                updateLockUI();
                closePasswordModal();
            } else {
                alert("ÂØÜÁ¢ºÈåØË™§ÔºÅ"); input.value = ''; input.focus();
            }
        }

        function updateLockUI() {
            const btn = document.getElementById('masterLockBtn');
            const container = document.getElementById('seatingContainer');
            
            // ÈúÄË¶ÅË¢´Á¶ÅÁî®ÁöÑÊåâÈàïÂÄë
            const controlledBtns = [
                document.getElementById('btnShuffle'),
                document.getElementById('btnReset'),
                document.getElementById('btnList'),
                ...document.getElementById('gridControls').querySelectorAll('button')
            ];

            if (isLocked) {
                btn.innerHTML = 'üîí ÈéñÂÆö';
                btn.className = 'btn btn-red';
                container.classList.add('locked');
                controlledBtns.forEach(b => b.classList.add('disabled'));
            } else {
                btn.innerHTML = 'üîì Á∑®ËºØ‰∏≠';
                btn.className = 'btn btn-green';
                container.classList.remove('locked');
                controlledBtns.forEach(b => b.classList.remove('disabled'));
            }
        }

        function openPasswordModal() {
            const modal = document.getElementById('passwordModal');
            const input = document.getElementById('adminPasswordInput');
            input.value = '';
            modal.style.display = 'flex';
            setTimeout(() => input.focus(), 300);
        }
        function closePasswordModal() { document.getElementById('passwordModal').style.display = 'none'; }

        // --- Core Functions ---
        function reshuffleSeating() {
            if(isLocked) return; // ÂÆâÂÖ®Ê™¢Êü•
            const s = document.querySelectorAll('.seat-box:not(.empty)');
            let pool = []; s.forEach(x => pool.push({id:x.querySelector('.seat-num').innerText, name:x.querySelector('.seat-name').innerText}));
            if(!pool.length) return;
            for(let i=pool.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
            
            const action = () => {
                s.forEach((x,i) => {
                    x.innerHTML = `<div class="seat-close" onclick="deleteSeat(event,this)">√ó</div><div class="seat-num">${pool[i].id}</div><div class="seat-name">${pool[i].name}</div>`;
                    x.style.viewTransitionName = pool[i].id ? 'seat-'+pool[i].id : 'seat-n-'+Math.random();
                });
                students = pool;
            };
            document.startViewTransition ? document.startViewTransition(action) : action();
            saveToLocal();
        }

        function performReset() {
            if(isLocked) return; // ÂÆâÂÖ®Ê™¢Êü•
            if(confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫Ë≥áÊñô‰∏¶ÈÇÑÂéüÈ†êË®≠ÂÄºÂóéÔºü")) {
                localStorage.removeItem(SAVE_KEY);
                location.reload();
            }
        }

        // --- Other Interactions ---
        function handleFocus(el) { setTimeout(() => { if(document.activeElement===el) { if(el.tagName!='TEXTAREA') el.select(); el.scrollIntoView({block:'center'}); } }, 300); }
        function toggleFullscreen() { !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen(); }
        
        // --- Clock Logic ---
        function updateClock(){
            const now = new Date();
            document.getElementById('clockDate').innerText = `${now.getMonth()+1}/${now.getDate()}`;
            updateFlipUnit('flipH', now.getHours()); updateFlipUnit('flipM', now.getMinutes());
            
            const subs = document.querySelectorAll('.subject-item');
            const nSec = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
            let act=null, nxt=null, minD=Infinity;
            subs.forEach(e => e.classList.remove('active'));

            subs.forEach(e => {
                const s=e.querySelector('.time-start').value.split(':'), en=e.querySelector('.time-end').value.split(':');
                if(s.length<2||en.length<2) return;
                const ss = s[0]*3600+s[1]*60, es = en[0]*3600+en[1]*60;
                if(nSec >= ss && nSec < es) act = {el:e, nm:e.querySelector('.subject-input').value, end:es, dur:es-ss};
                else if(nSec < ss && (ss-nSec) < minD) { minD=ss-nSec; nxt={nm:e.querySelector('.subject-input').value, diff:minD}; }
            });

            const stTxt=document.getElementById('statusText'), rm=document.getElementById('remainingTime'), bar=document.getElementById('progressFill'), card=document.getElementById('statusCard');
            if(act) {
                act.el.classList.add('active');
                const rem = act.end - nSec;
                rm.innerText = fmt(rem); stTxt.innerText = `${act.nm} ËÄÉË©¶‰∏≠`;
                bar.style.width = ((act.dur-rem)/act.dur*100)+'%';
                card.className = rem < 300 ? 'status-card urgent' : 'status-card';
            } else if(nxt) {
                rm.innerText = "--:--"; stTxt.innerText = `Ë∑ùÈõ¢ ${nxt.nm} ÈÇÑÊúâ ${fmt(nxt.diff)}`;
                bar.style.width = '0%'; card.className = 'status-card';
            } else {
                rm.innerText = "‰ºëÊÅØ"; stTxt.innerText = "ÁõÆÂâçÁÑ°ËÄÉË©¶"; bar.style.width = '0%'; card.className = 'status-card';
            }
        }
        function fmt(s){ return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0'); }
        function updateFlipUnit(id, v) {
            const el = document.getElementById(id), top = el.querySelector('.flip-top span'), bot = el.querySelector('.flip-bottom span');
            const val = String(v).padStart(2,'0');
            if(top.innerText === val) return;
            top.innerText = val; bot.innerText = val; // Simplify animation for reliability
        }

        // --- Drag & Drop ---
        let dragItem=null, ghost=null, dx=0, dy=0;
        function enableDrag(s) { s.onmousedown=dragStart; s.ontouchstart=dragStart; }
        function dragStart(e) {
            if(isLocked) return; // ÈéñÂÆöÊôÇÁÑ°Ê≥ïÊãñÊõ≥
            if(e.target.className.includes('close') || this.classList.contains('empty')) return;
            e.preventDefault(); dragItem=this;
            const t = e.touches ? e.touches[0] : e;
            dx = t.clientX; dy = t.clientY;
            ghost = this.cloneNode(true); ghost.className += ' seat-ghost';
            const r = this.getBoundingClientRect();
            ghost.style.width=r.width+'px'; ghost.style.height=r.height+'px';
            ghost.style.left=r.left+'px'; ghost.style.top=r.top+'px';
            document.body.appendChild(ghost); this.style.opacity='0.5';
            window.addEventListener('mousemove', dragMove); window.addEventListener('touchmove', dragMove, {passive:false});
            window.addEventListener('mouseup', dragEnd); window.addEventListener('touchend', dragEnd);
        }
        function dragMove(e) {
            if(!dragItem) return; e.preventDefault();
            const t = e.touches ? e.touches[0] : e;
            ghost.style.left = (ghost.offsetLeft + (t.clientX - dx)) + 'px';
            ghost.style.top = (ghost.offsetTop + (t.clientY - dy)) + 'px';
            dx=t.clientX; dy=t.clientY;
            document.querySelectorAll('.seat-box').forEach(b => b.classList.remove('drag-over'));
            const el = document.elementFromPoint(dx, dy)?.closest('.seat-box');
            if(el && el !== dragItem) el.classList.add('drag-over');
        }
        function dragEnd(e) {
            if(!dragItem) return;
            ghost.remove(); dragItem.style.opacity='1';
            const t = e.changedTouches ? e.changedTouches[0] : e;
            const el = document.elementFromPoint(t.clientX, t.clientY)?.closest('.seat-box');
            if(el && el !== dragItem) {
                const sH = dragItem.innerHTML, sC = dragItem.className, sV = dragItem.style.viewTransitionName;
                dragItem.innerHTML = el.innerHTML; dragItem.className = el.className; dragItem.style.viewTransitionName = el.style.viewTransitionName;
                el.innerHTML = sH; el.className = sC; el.style.viewTransitionName = sV;
                updateStudentsFromDOM(); saveToLocal();
            }
            document.querySelectorAll('.seat-box').forEach(b => b.classList.remove('drag-over'));
            dragItem = null;
            window.removeEventListener('mousemove', dragMove); window.removeEventListener('touchmove', dragMove);
            window.removeEventListener('mouseup', dragEnd); window.removeEventListener('touchend', dragEnd);
        }

        // --- Grid Helpers ---
        function getGridFromDOM() {
            return Array.from(document.querySelectorAll('.seat-column')).map(c => ({
                label: c.querySelector('.col-label-input').value,
                seats: Array.from(c.querySelectorAll('.seat-box')).map(s => s.classList.contains('empty') ? null : {id:s.querySelector('.seat-num').innerText, name:s.querySelector('.seat-name').innerText})
            }));
        }
        function renderGridToDOM(grid) {
            const c = document.getElementById('classroomLayout'); c.innerHTML='';
            grid.forEach(col => {
                const d = document.createElement('div'); d.className='seat-column';
                col.seats.forEach(s => {
                    const sb = s ? createSeat(s.id, s.name) : createEmpty();
                    d.appendChild(sb);
                });
                const inp = document.createElement('input'); inp.className='col-label-input'; inp.value=col.label;
                d.appendChild(inp); c.appendChild(d);
            });
        }
        function createSeat(id, name) {
            const s = document.createElement('div'); s.className = 'seat-box';
            s.innerHTML = `<div class="seat-close" onclick="deleteSeat(event,this)">√ó</div><div class="seat-num">${id}</div><div class="seat-name">${name}</div>`;
            s.style.viewTransitionName = id ? 'seat-'+id : 'seat-n-'+Math.random();
            enableDrag(s); return s;
        }
        function createEmpty() {
            const s = document.createElement('div'); s.className = 'seat-box empty';
            s.innerHTML = '<div class="add-sign">+</div>';
            s.onclick = function() { if(!isLocked) addNewStudent(this); };
            return s;
        }
        
        // --- Seat Edit ---
        let targetSeat = null;
        function addNewStudent(el) {
            targetSeat = el;
            document.getElementById('newStudentId').value=''; document.getElementById('newStudentName').value='';
            document.getElementById('singleStudentModal').style.display='flex';
            setTimeout(()=>document.getElementById('newStudentId').focus(),300);
        }
        function confirmAddStudent() {
            if(!targetSeat) return;
            const nm = document.getElementById('newStudentName').value.trim();
            if(!nm) return alert('Ë´ãËº∏ÂÖ•ÂßìÂêç');
            const id = document.getElementById('newStudentId').value.trim();
            targetSeat.className = 'seat-box';
            targetSeat.innerHTML = `<div class="seat-close" onclick="deleteSeat(event,this)">√ó</div><div class="seat-num">${id}</div><div class="seat-name">${nm}</div>`;
            targetSeat.style.viewTransitionName = id ? 'seat-'+id : 'seat-n-'+Math.random();
            targetSeat.onclick = null; enableDrag(targetSeat);
            updateStudentsFromDOM(); saveToLocal(); closeSingleStudentModal();
        }
        window.deleteSeat = function(e, btn) {
            if(isLocked) return;
            e.stopPropagation();
            const p = btn.parentElement; p.className='seat-box empty'; p.innerHTML='<div class="add-sign">+</div>';
            p.onclick = function() { if(!isLocked) addNewStudent(this); };
            p.style.viewTransitionName=''; updateStudentsFromDOM(); saveToLocal();
        }
        function updateStudentsFromDOM() { students=[]; document.querySelectorAll('.seat-box:not(.empty)').forEach(s => students.push({id:s.querySelector('.seat-num').innerText, name:s.querySelector('.seat-name').innerText})); }
        function closeSingleStudentModal(){ document.getElementById('singleStudentModal').style.display='none'; }

        // --- Subject/Att ---
        function addSubject(){ 
            if(isLocked) return; // Á∞°ÂñÆÈò≤ÂëÜÔºåÈõñÁÑ∂‰ªãÈù¢Ê≤íÈéñ
            const l=document.getElementById('subjectList'); 
            l.insertBefore(createSubjectEl('ÁßëÁõÆ','12:00','13:00'), document.getElementById('addSubjectBtn'));
        }
        window.removeSubject = function(b) { b.closest('.subject-item').remove(); }
        function formatTimeInput(i){ 
            let v=i.value.replace(/\D/g,''); if(!v)return;
            if(v.length>=3 && !i.value.includes(':')) v=v.slice(0,2)+':'+v.slice(2);
            i.value=v;
        }

        // --- View Controls ---
        const vT=document.getElementById('viewToggle'), dT=document.getElementById('dirToggle');
        function setView(v){ vT.checked=v; dT.checked=!vT.checked; triggerView(); }
        function setDirection(d){ dT.checked=d; triggerView(); }
        vT.onchange=()=>{ dT.checked=!vT.checked; triggerView(); };
        dT.onchange=triggerView;
        function triggerView(){
            const isS = vT.checked;
            document.getElementById('seatingContainer').className = `seating-container ${isLocked?'locked':''} ${isS?'student-view':''}`;
            const g = getGridFromDOM().reverse().map(c=>({ ...c, seats: c.seats.reverse() }));
            renderGridToDOM(g);
            document.querySelectorAll('.seat-column').forEach((c,i)=>{
                const n = dT.checked ? (7-i) : (i+1);
                const inp=c.querySelector('.col-label-input');
                if(inp.value.match(/^Á¨¨\d+Êéí$/)) inp.value=`Á¨¨${n}Êéí`;
            });
            saveToLocal();
        }

        // --- Password input enter key ---
        document.getElementById('adminPasswordInput').addEventListener('keydown', e=>{if(e.key==='Enter')checkPassword()});
        
        // --- Init ---
        setInterval(updateClock, 1000); updateClock();
        
        // --- Grid Add/Remove wrappers ---
        window.addColumn=function(){ if(isLocked)return; /* logic omitted for brevity, same as before but safe */ const c=document.getElementById('classroomLayout'); const d=document.createElement('div'); d.className='seat-column'; for(let i=0;i<6;i++)d.appendChild(createEmpty()); d.appendChild(Object.assign(document.createElement('input'),{className:'col-label-input',value:'Êñ∞Êéí'})); c.appendChild(d); triggerView(); }
        window.removeColumn=function(){ if(isLocked)return; const c=document.getElementById('classroomLayout'); if(c.children.length) c.lastElementChild.remove(); saveToLocal(); }
        window.addRow=function(){ if(isLocked)return; document.querySelectorAll('.seat-column').forEach(c=>{ const s=createEmpty(); c.insertBefore(s, c.querySelector('.col-label-input')); }); saveToLocal(); }
        window.removeRow=function(){ if(isLocked)return; document.querySelectorAll('.seat-column').forEach(c=>{ const s=c.querySelectorAll('.seat-box'); if(s.length) s[s.length-1].remove(); }); saveToLocal(); }

        // --- Init Resizer (Compact) ---
        document.querySelectorAll('.resizer').forEach(r=>{
            r.addEventListener('mousedown', initResize); r.addEventListener('touchstart', initResize);
        });
        function initResize(e) {
            const isV = e.target.classList.contains('resizer-v');
            const prev = e.target.previousElementSibling;
            const start = isV ? (e.touches?e.touches[0].clientX:e.clientX) : (e.touches?e.touches[0].clientY:e.clientY);
            const startSize = isV ? prev.getBoundingClientRect().width : prev.getBoundingClientRect().height;
            const onMove = (mv) => {
                const cur = isV ? (mv.touches?mv.touches[0].clientX:mv.clientX) : (mv.touches?mv.touches[0].clientY:mv.clientY);
                const newSize = startSize + (cur - start);
                if(isV) prev.style.width=newSize+'px'; else prev.style.height=newSize+'px';
                prev.style.flex='none';
            };
            const onEnd = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onEnd); window.removeEventListener('touchmove', onMove); window.removeEventListener('touchend', onEnd); };
            window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onEnd); window.addEventListener('touchmove', onMove, {passive:false}); window.addEventListener('touchend', onEnd);
        }
    </script>
</body>
</html>
