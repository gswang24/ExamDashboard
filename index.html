<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Áõ£ËÄÉÂÑÄË°®Êùø v0113.2 (Ê†ºÂ±ÄË®òÊÜ∂)</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚è≥</text></svg>">

    <style>
        :root {
            --c-grey:   #231F20;
            --c-red:    #BB4430;
            --c-teal:   #7EBDC2;
            --c-yellow: #F3DFA2;
            --c-linen:  #EFE6DD;
            --bg-body:  #f0f0f0;
            --clock-bg: #333;
            --clock-text:#f0f0f0;
            --gap-size: 14px;
        }

        /* --- ÂãïÁï´ÊéßÂà∂ÂçÄ --- */
        ::view-transition-group(*) { 
            animation-duration: 0.3s; 
            animation-timing-function: cubic-bezier(0.2, 0, 0.2, 1);
        }
        
        ::view-transition-old(root), 
        ::view-transition-new(root) {
            animation: none;
            mix-blend-mode: normal;
        }

        .col-label-input, .podium { view-transition-name: none !important; }

        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-touch-callout: none; 
            -webkit-user-select: none;
            user-select: none;
        }

        input, textarea { 
            -webkit-user-select: text !important; 
            user-select: text !important; 
            cursor: text;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            margin: 0; 
            padding: 10px 15px calc(15px + env(safe-area-inset-bottom)) 15px;
            height: 100vh;
            height: 100dvh; 
            display: flex; flex-direction: column;
            overflow: hidden; color: var(--c-grey);
            position: fixed; width: 100%;
        }

        body:fullscreen, body:-webkit-full-screen {
            padding: 0; 
            background-color: var(--c-grey);
        }
        body:fullscreen .clock-card,
        body:fullscreen .status-card,
        body:fullscreen .schedule-column .subject-list,
        body:fullscreen .attendance-card,
        body:fullscreen .seating-container {
            border-radius: 0; 
            border-width: 0 1px 1px 0; 
        }

        #fullscreenBtn {
            position: fixed; top: 10px; right: 10px; z-index: 3000;
            background-color: rgba(35, 31, 32, 0.8); color: #fff;
            border: none; border-radius: 6px; padding: 6px 10px;
            cursor: pointer; font-weight: bold; font-size: 0.8rem;
            transition: 0.2s; backdrop-filter: blur(2px);
        }
        #fullscreenBtn:hover { transform: scale(1.05); background-color: #000; }
        body:fullscreen #fullscreenBtn { opacity: 0.3; }
        body:fullscreen #fullscreenBtn:hover { opacity: 1; }

        .version-tag {
            position: fixed; top: 12px; left: 15px; z-index: 3000;
            color: var(--c-grey); font-weight: 900; font-size: 0.9rem;
            opacity: 0.4; pointer-events: none;
            font-family: 'Courier New', monospace;
            display: none;
        }

        /* --- Resizer --- */
        .resizer { 
            z-index: 100; flex-shrink: 0; 
            display: flex; align-items: center; justify-content: center; 
            background-color: transparent; 
            touch-action: none; 
            transition: background-color 0.2s;
        }
        .resizer:hover { background-color: rgba(0,0,0,0.05); border-radius: 4px; }
        .resizer-v { width: var(--gap-size); cursor: col-resize; height: 100%; margin: 0; position: relative; }
        .resizer-h { height: var(--gap-size); cursor: row-resize; width: 100%; margin: 0; position: relative; }

        body.is-resizing { cursor: col-resize !important; }
        body.is-resizing.row-resize { cursor: row-resize !important; } 
        body.is-resizing * { pointer-events: none; } 

        .header-row { display: flex; height: 170px; min-height: 80px; flex-shrink: 0; transition: height 0.1s; }

        .clock-card {
            background-color: var(--c-yellow); color: var(--c-grey);
            border: 2px solid var(--c-grey); border-radius: 16px;
            padding: 8px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            flex: 1; 
            min-width: 220px; 
            box-shadow: 4px 4px 0px rgba(35, 31, 32, 0.15);
            overflow: hidden; position: relative;
        }
        
        .clock-label { 
            font-size: 1.8rem; font-weight: bold; opacity: 0.8; letter-spacing: 2px; margin-bottom: 2px; color: var(--c-grey);
            transition: font-size 0.2s, margin 0.2s; white-space: nowrap;
        }
        .clock-date { 
            font-size: 1rem; font-weight: bold; opacity: 0.7; margin-bottom: 5px; font-family: 'Segoe UI', sans-serif; 
            transition: font-size 0.2s, margin 0.2s; white-space: nowrap;
        }
        .flip-clock-container { display: flex; gap: 8px; align-items: center; justify-content: center; transition: gap 0.2s; }
        
        .flip-unit {
            position: relative; width: 90px; height: 70px; perspective: 400px;
            background-color: var(--clock-bg); border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); font-family: 'Courier New', monospace;
            font-weight: 800; font-size: 3.5rem; line-height: 70px; color: var(--clock-text); text-align: center;
            transition: width 0.2s, height 0.2s, font-size 0.2s, line-height 0.2s;
        }
        .flip-top, .flip-bottom { position: absolute; left: 0; width: 100%; height: 50%; overflow: hidden; background-color: var(--clock-bg); }
        .flip-top { top: 0; border-radius: 6px 6px 0 0; z-index: 1; border-bottom: 1px solid rgba(0,0,0,0.3); }
        .flip-bottom { bottom: 0; border-radius: 0 0 6px 6px; z-index: 0; }
        .flip-top span { position: absolute; top: 0; left: 0; width: 100%; height: 200%; display: flex; justify-content: center; align-items: center; }
        .flip-bottom span { position: absolute; top: -100%; left: 0; width: 100%; height: 200%; display: flex; justify-content: center; align-items: center; }
        .flip-leaf-front, .flip-leaf-back { position: absolute; left: 0; width: 100%; height: 50%; overflow: hidden; backface-visibility: hidden; background-color: var(--clock-bg); }
        .flip-leaf-front { top: 0; border-radius: 6px 6px 0 0; transform-origin: 50% 100%; z-index: 2; border-bottom: 1px solid rgba(0,0,0,0.3); }
        .flip-leaf-back { top: 50%; border-radius: 0 0 6px 6px; transform-origin: 50% 0%; z-index: 2; transform: rotateX(180deg); }
        .flip-leaf-front span { position: absolute; top: 0; left: 0; width: 100%; height: 200%; display: flex; justify-content: center; align-items: center; }
        .flip-leaf-back span { position: absolute; top: -100%; left: 0; width: 100%; height: 200%; display: flex; justify-content: center; align-items: center; }
        
        .flip-unit.flipping .flip-leaf-front { animation: flipDownFront 0.4s ease-in-out forwards; } 
        .flip-unit.flipping .flip-leaf-back { animation: flipDownBack 0.4s ease-in-out forwards; } 
        @keyframes flipDownFront { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(-180deg); } }
        @keyframes flipDownBack { 0% { transform: rotateX(180deg); } 100% { transform: rotateX(0deg); } }
        .flip-sep { font-size: 3rem; font-weight: 800; color: var(--c-grey); padding-bottom: 10px; line-height: 1; transition: font-size 0.2s, padding 0.2s; }

        .status-card {
            flex: 5;
            background-color: var(--c-grey); color: var(--c-linen);
            border-radius: 16px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; position: relative;
            overflow: hidden; min-width: 200px; border: 2px solid var(--c-grey);
            box-shadow: 4px 4px 0px rgba(0,0,0,0.15); 
        }
        .status-label { font-size: 1.8rem; color: #ccc; margin-bottom: 2px; z-index: 2; letter-spacing: 2px; font-weight: bold; transition: font-size 0.2s, margin 0.2s; }
        .status-time { font-size: 5rem; font-weight: bold; z-index: 2; font-family: 'Courier New', monospace; line-height: 1; color: var(--c-teal); transition: font-size 0.2s; }
        .status-sub { font-size: 1.2rem; color: #fff; z-index: 2; margin-top: 5px; font-weight: bold; transition: font-size 0.2s, margin 0.2s; }
        .status-card.urgent .status-time { color: var(--c-red); }
        .progress-bg { position: absolute; left: 0; bottom: 0; top: 0; width: 0%; background-color: rgba(243, 223, 162, 0.5); transition: width 1s linear; z-index: 1; }

        .header-row.compact .clock-card, .header-row.compact .status-card { padding: 4px; }
        .header-row.compact .clock-label { font-size: 1.2rem; margin-bottom: 2px; }
        .header-row.compact .clock-date { font-size: 0.9rem; margin-bottom: 4px; display: none; }
        .header-row.compact .flip-unit { width: 60px; height: 50px; font-size: 2.0rem; line-height: 50px; border-radius: 4px; }
        .header-row.compact .flip-sep { font-size: 2rem; padding-bottom: 5px; }
        .header-row.compact .status-label { font-size: 1.2rem; margin-bottom: 0; }
        .header-row.compact .status-time { font-size: 3.5rem; }
        .header-row.compact .status-sub { font-size: 1rem; margin-top: 2px; }

        .content-row { 
            display: flex; flex: 1; overflow: hidden; height: 100%; position: relative; 
            min-height: 0;
        }
        
        .schedule-column { 
            flex: 1; min-width: 250px; 
            display: flex; flex-direction: column; 
            gap: 0; flex-shrink: 0; height: 100%; position: relative;
        }
        
        .subject-list { 
            background-color: var(--c-teal); border: 2px solid var(--c-grey);
            border-radius: 16px; padding: 12px; overflow-y: auto; 
            box-shadow: 4px 4px 0px rgba(35, 31, 32, 0.15);
            display: flex; flex-direction: column; gap: 8px;
            flex-grow: 1; flex-shrink: 1; min-height: 100px;
            -webkit-overflow-scrolling: touch; 
        }
        
        .subject-item { 
            display: flex; flex-direction: column; padding: 10px; 
            border-radius: 8px; gap: 4px; background: #fff; 
            border: 2px solid transparent; box-shadow: 2px 2px 0px rgba(0,0,0,0.05);
            transition: 0.3s; flex-shrink: 0; 
        }
        .subject-item.active { border: 2px solid var(--c-grey); background-color: var(--c-yellow); transform: scale(1.02); box-shadow: 4px 4px 0px rgba(0,0,0,0.1); }
        .subject-header { display: flex; justify-content: space-between; align-items: center; }
        .subject-input { font-size: 1.3rem; font-weight: 800; border: none; outline: none; background: transparent; width: 80%; color: var(--c-grey); padding: 5px 0; }
        .time-inputs { display: flex; align-items: center; gap: 5px; }
        .time-input { 
            border: 1px solid #ddd; border-radius: 4px; padding: 5px; 
            font-size: 1.2rem; font-weight: bold; width: 100%; text-align: center; 
            color: var(--c-grey); background: #f9f9f9; 
            font-family: 'Courier New', monospace; letter-spacing: 1px;
            cursor: text;
        }
        .time-input:focus { border-color: var(--c-grey); background: #fff; outline: none; }
        
        .attendance-card { 
            background-color: var(--c-grey);
            border: 2px solid var(--c-grey);
            border-radius: 16px; 
            height: 160px;
            min-height: 60px;
            flex-shrink: 0; display: flex; overflow: hidden; 
            box-shadow: 4px 4px 0px rgba(35, 31, 32, 0.15);
            padding: 5px; gap: 5px; transition: height 0.1s;
            container-type: inline-size;
        }
        
        .att-box { 
            flex: 1; display: flex; flex-direction: column; padding: 8px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.1); 
            background: rgba(255, 255, 255, 0.05);
            overflow: hidden; position: relative;
        }
        
        .att-box:nth-child(1) { border-color: var(--c-teal); background: rgba(126, 189, 194, 0.1); }
        .att-box:nth-child(1) .att-val { color: var(--c-teal); }

        .att-box:nth-child(2) { border-color: var(--c-yellow); background: rgba(243, 223, 162, 0.1); }
        .att-box:nth-child(2) .att-val { color: var(--c-yellow); }

        .att-box:nth-child(3) { flex: 1.8; border-color: var(--c-red); background: rgba(187, 68, 48, 0.1); }
        
        .att-label { 
            font-size: 1.1rem; font-weight: 900; width: 100%; text-align: left; 
            color: #ccc; margin: 0; line-height: 1; flex-shrink: 0; 
        }
        
        .att-val { 
            font-size: clamp(2rem, 11cqi, 4.5rem); 
            font-weight: 800; background: transparent; border: none; 
            text-align: center; outline: none; padding: 0; margin: 0;
            margin-top: auto; margin-bottom: auto; width: 100%;
            box-sizing: border-box; line-height: 1;
        }

        textarea.att-val { 
            resize: none; height: auto; flex-grow: 1; width: 100%;
            font-size: clamp(1rem, 5cqi, 1.3rem); line-height: 1.4; 
            border: 2px dashed rgba(187, 68, 48, 0.5);
            border-radius: 8px; margin-top: 5px; margin-bottom: 0;
            padding: 5px 8px; color: #ff5252; font-weight: bold;
            background: rgba(0,0,0,0.2); text-align: left;
        }
        textarea.att-val::placeholder { color: rgba(255,255,255,0.3); font-weight: normal; }
        
        .attendance-card.compact .att-box { padding: 4px; }
        .attendance-card.compact .att-label { font-size: 0.9rem; }
        .attendance-card.compact .att-val { font-size: clamp(1.5rem, 10cqi, 3.5rem); }
        .attendance-card.compact textarea.att-val { border-width: 1px; font-size: 1rem; margin-top: 2px; padding: 2px 5px; }

        #addSubjectBtn { width: 100%; border-style: dashed; background: rgba(255,255,255,0.5); margin-top: auto; }

        .seating-container {
            flex: 3.5; background-color: var(--c-linen);
            border: 2px solid var(--c-grey); border-radius: 16px;
            box-shadow: 4px 4px 0px rgba(35, 31, 32, 0.15); 
            padding: 8px;
            display: flex; flex-direction: column; 
            position: relative; min-width: 0; overflow: hidden; 
        }

        .seating-toolbar { 
            display: flex; justify-content: space-between; margin-bottom: 5px;
            align-items: center; flex-wrap: wrap; gap: 5px; flex-shrink: 0; 
        }

        .view-control-group {
            display: flex; align-items: center; gap: 8px; 
            margin-left: auto; margin-right: 10px;
            background: rgba(255,255,255,0.5);
            padding: 4px 10px; border-radius: 20px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .view-label { font-size: 0.9rem; font-weight: bold; color: var(--c-grey); cursor: pointer; }
        
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #999; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--c-teal); }
        input:checked + .slider:before { transform: translateX(20px); }

        .btn { padding: 6px 12px; border-radius: 8px; border: 2px solid var(--c-grey); cursor: pointer; font-weight: bold; font-size: 0.95rem; white-space: nowrap; transition: 0.1s; box-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        .btn:active { transform: translate(2px, 2px); box-shadow: none; }
        .btn-main { background: var(--c-grey); color: #fff; }
        .btn-sec { background: #fff; color: var(--c-grey); }
        .btn-tiny { font-size: 0.8rem; padding: 4px 8px; background: #fff; opacity: 0.9; }

        .classroom-layout {
            flex: 1; display: flex; flex-direction: row; flex-wrap: nowrap; 
            justify-content: center; align-items: stretch; gap: 4px; padding-bottom: 5px;
            overflow: auto; width: 100%; -webkit-overflow-scrolling: touch; order: 1; 
        }
        
        .seat-column { 
            display: flex; flex-direction: column; gap: 4px; align-items: center; 
            flex: 1; min-width: 60px; 
            height: 100%; min-height: 100px;
        }
        
        .col-label-input { 
            flex: 0 0 auto; margin-top: 5px; width: 100%; text-align: center; 
            background: transparent; border: 1px solid transparent; border-radius: 4px; 
            font-weight: 800; color: var(--c-grey); font-size: 0.9rem; opacity: 0.7; outline: none; 
            order: 999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            flex-shrink: 0; pointer-events: none; 
        }

        .seating-container.student-view .col-label-input { order: -1; margin-top: 0; margin-bottom: 5px; }

        .seat-box {
            width: 100%; flex: 1 1 0%; min-height: 0; 
            border: 2px solid var(--c-grey); border-radius: 6px; display: flex; background: #fff;
            position: relative; box-sizing: border-box; cursor: grab;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.05);
            overflow: hidden; touch-action: none; 
            container-type: size;
        }
        .seat-box:active { cursor: grabbing; transform: scale(0.98); }
        .seat-ghost { position: fixed; z-index: 9999; pointer-events: none; opacity: 0.8; box-shadow: 4px 4px 10px rgba(0,0,0,0.2); transform: scale(1.05) rotate(2deg); background: #fff; border: 2px solid var(--c-teal); }
        .seat-box.drag-over { background-color: var(--c-teal); border-color: var(--c-grey); color: #fff; }
        .seat-box.empty { border: 2px dashed #bbb; background-color: rgba(255,255,255,0.4); color: #999; justify-content: center; align-items: center; cursor: pointer; box-shadow: none; }
        .seat-box.empty:hover { border-color: var(--c-grey); color: var(--c-grey); background-color: #fff; }
        .add-sign { font-size: 2rem; font-weight: bold; pointer-events: none; }
        .seat-num { width: 25px; min-width: 20px; border-right: 2px solid var(--c-grey); display: flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: 900; background: var(--c-yellow); color: var(--c-grey); flex-shrink: 0; pointer-events: none; }
        
        .seat-name { 
            flex: 1; display: flex; align-items: center; justify-content: center; 
            font-size: clamp(0.8rem, min(24cqw, 50cqh), 3.5rem); 
            font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            pointer-events: none; padding: 0 2px; line-height: 1.1;
        }

        .seat-close { position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: var(--c-red); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; cursor: pointer; opacity: 0; transition: 0.2s; z-index: 5; border: 1px solid #fff; }
        .seat-box:hover .seat-close { opacity: 1; }
        .seat-highlight { background-color: var(--c-teal) !important; color: #fff; }
        .seat-highlight .seat-num { background-color: #fff; color: var(--c-teal); }

        .podium {
            width: 180px; height: 35px; border: 3px solid var(--c-grey); 
            background: var(--c-grey); color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; letter-spacing: 5px; pointer-events: none;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.1); border-radius: 8px;
            margin: 5px 0; align-self: center; order: 2; z-index: 10; font-size: 0.9rem;
        }
        .seating-container.student-view .podium { order: 0; margin-bottom: 10px; }

        .modal-overlay { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(35, 31, 32, 0.7); display: none; 
            align-items: flex-start; padding-top: 50px; overflow-y: auto;        
            z-index: 10000; backdrop-filter: blur(2px); 
            -webkit-overflow-scrolling: touch; 
        }
        
        .modal { 
            background: #fff; padding: 25px; border-radius: 16px; width: 450px; 
            border: 4px solid var(--c-grey); box-shadow: 8px 8px 0px var(--c-yellow); 
            margin: 0 auto 50vh auto; flex-shrink: 0; max-width: 90%;
        }
        
        .modal h3 { margin-top: 0; color: var(--c-grey); }
        .modal input[type="text"], .modal textarea { width: 100%; margin: 5px 0 15px 0; padding: 10px; border: 2px solid var(--c-grey); border-radius: 8px; font-size: 1rem; }
        .modal textarea { height: 200px; }
        .modal-footer { text-align: right; gap: 15px; display: flex; justify-content: flex-end; }
        .btn-delete { background: none; border: none; color: #ccc; font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
        .btn-delete:hover { color: var(--c-red); transform: scale(1.2); }
        
        .modal-input { margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="version-tag">v0113.2</div>

    <button id="fullscreenBtn" onclick="toggleFullscreen()">
        <span style="font-size:1.2rem">‚õ∂</span> ÂÖ®Ëû¢Âπï
    </button>

    <div class="header-row" id="headerRow">
        <div class="clock-card" id="clockCard">
            <div class="clock-label">ÁõÆÂâçÊôÇÈñì</div>
            <div class="clock-date" id="clockDate">YYYY/MM/DD ÊòüÊúüN</div>
            <div class="flip-clock-container">
                <div class="flip-unit" id="flipH">
                    <div class="flip-top"><span>00</span></div>
                    <div class="flip-bottom"><span>00</span></div>
                </div>
                <div class="flip-sep">:</div>
                <div class="flip-unit" id="flipM">
                    <div class="flip-top"><span>00</span></div>
                    <div class="flip-bottom"><span>00</span></div>
                </div>
            </div>
        </div>
        <div class="resizer resizer-v" id="resizerHeader"></div>
        <div class="status-card" id="statusCard">
            <div class="progress-bg" id="progressFill"></div>
            <div class="status-label">Ââ©È§òÊôÇÈñì</div>
            <div class="status-time" id="remainingTime">--:--</div>
            <div class="status-sub" id="statusText">Á≠âÂæÖ‰∏≠</div>
        </div>
    </div>

    <div class="resizer resizer-h" id="resizerMain"></div>

    <div class="content-row">
        <div class="schedule-column" id="scheduleCol">
            <div class="subject-list" id="subjectList">
                <div class="subject-item">
                    <div class="subject-header">
                        <input type="text" class="subject-input" value="ÁîüÁâ©" onfocus="handleFocus(this)">
                        <button class="btn-delete" onclick="removeSubject(this)">√ó</button>
                    </div>
                    <div class="time-inputs">
                        <input type="text" class="time-input time-start" value="13:20" maxlength="5" placeholder="13:20" onfocus="handleFocus(this)" onblur="formatTimeInput(this)">
                        <span class="time-sep">~</span>
                        <input type="text" class="time-input time-end" value="14:10" maxlength="5" placeholder="14:10" onfocus="handleFocus(this)" onblur="formatTimeInput(this)">
                    </div>
                </div>
                <div class="subject-item">
                    <div class="subject-header">
                        <input type="text" class="subject-input" value="ÁêÜÂåñ" onfocus="handleFocus(this)">
                        <button class="btn-delete" onclick="removeSubject(this)">√ó</button>
                    </div>
                    <div class="time-inputs">
                        <input type="text" class="time-input time-start" value="14:20" maxlength="5" placeholder="HH:mm" onfocus="handleFocus(this)" onblur="formatTimeInput(this)">
                        <span class="time-sep">~</span>
                        <input type="text" class="time-input time-end" value="15:10" maxlength="5" placeholder="HH:mm" onfocus="handleFocus(this)" onblur="formatTimeInput(this)">
                    </div>
                </div>
                
                <button id="addSubjectBtn" class="btn btn-tiny" onclick="addSubject()">+ Êñ∞Â¢ûÁßëÁõÆ</button>
            </div>

            <div class="resizer resizer-h" id="resizerSubjectSplit"></div>

            <div class="attendance-card" id="attendanceCard">
                <div class="att-box">
                    <div class="att-label">ÊáâÂà∞</div>
                    <input type="number" class="att-val" value="0" onfocus="handleFocus(this)">
                </div>
                <div class="att-box">
                    <div class="att-label">ÂØ¶Âà∞</div>
                    <input type="number" class="att-val" value="0" onfocus="handleFocus(this)">
                </div>
                <div class="att-box">
                    <div class="att-label">Êú™Âà∞ËôüÁ¢º</div>
                    <textarea class="att-val" placeholder="ÁÑ°" onfocus="handleFocus(this)"></textarea>
                </div>
            </div>
        </div>

        <div class="resizer resizer-v" id="resizerContent"></div>

        <div class="seating-container" id="seatingContainer">
            <div class="seating-toolbar">
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-tiny" onclick="addColumn()">+ Â¢ûÊéí(Áõ¥)</button>
                    <button class="btn btn-tiny" onclick="removeColumn()">- Âà™Êéí(Áõ¥)</button>
                    <button class="btn btn-tiny" onclick="addRow()">+ Â¢ûÂàó(Ê©´)</button>
                    <button class="btn btn-tiny" onclick="removeRow()">- Âà™Âàó(Ê©´)</button>
                </div>
                
                <div class="view-control-group">
                    <span class="view-label" onclick="setDirection(false)">Â∑¶Ëµ∑Á¨¨1Êéí</span>
                    <label class="switch">
                        <input type="checkbox" id="dirToggle">
                        <span class="slider"></span>
                    </label>
                    <span class="view-label" onclick="setDirection(true)">Âè≥Ëµ∑Á¨¨1Êéí</span>
                    
                    <div style="width:1px; height:20px; background:#ccc; margin:0 10px;"></div>

                    <span class="view-label" onclick="setView(false)">ËÄÅÂ∏´Ë¶ñËßí</span>
                    <label class="switch">
                        <input type="checkbox" id="viewToggle">
                        <span class="slider"></span>
                    </label>
                    <span class="view-label" onclick="setView(true)">Â≠∏ÁîüË¶ñËßí</span>
                </div>

                <div style="display:flex; gap:5px;">
                    <button class="btn btn-sec" onclick="openModal()">üìã ÂêçÂñÆ</button>
                    <button class="btn btn-main" onclick="reshuffleSeating()">üîÑ ÈáçÊéí</button>
                </div>
            </div>

            <div class="classroom-layout" id="classroomLayout">
            </div>

            <div class="podium">Ë¨õËá∫</div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal">
            <h3>Á∑®ËºØÂ≠∏ÁîüÂêçÂñÆ</h3>
            <p style="color:var(--c-grey); font-size:0.9rem;">ÊèêÁ§∫ÔºöËã•ÁÇ∫„Äå<strong>1 ÁéãÂ∞èÊòé</strong>„ÄçÊ†ºÂºèÔºåÊúÉÂ°´ÂÖ•Â∫ßËôüÔºõËã•ÂÉÖË≤º‰∏ä„Äå<strong>ÁéãÂ∞èÊòé</strong>„ÄçÔºåÂ∫ßËôüÊ¨ÑÂ∞áËá™ÂãïÁïôÁ©∫„ÄÇ</p>
            <textarea id="studentListInput" placeholder="‰æãÂ¶ÇÔºö
1 ÁéãÂ∞èÊòé
2 ÊùéÂ§ßËèØ" onfocus="this.select()"></textarea>
            <div class="modal-footer">
                <button class="btn btn-sec" onclick="closeModal()">ÂèñÊ∂à</button>
                <button class="btn btn-main" onclick="saveStudents()">Á¢∫Ë™ç</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="singleStudentModal">
        <div class="modal" style="width: 320px;">
            <h3>Êñ∞Â¢ûÂ≠∏Áîü</h3>
            <div style="margin-bottom: 10px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold; color:var(--c-grey);">Â∫ßËôü</label>
                <input type="text" id="newStudentId" class="modal-input" placeholder="‰æãÂ¶ÇÔºö1" onfocus="this.select()">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold; color:var(--c-grey);">ÂßìÂêç</label>
                <input type="text" id="newStudentName" class="modal-input" placeholder="‰æãÂ¶ÇÔºöÁéãÂ∞èÊòé" onfocus="this.select()">
            </div>
            <div class="modal-footer">
                <button class="btn btn-sec" onclick="closeSingleStudentModal()">ÂèñÊ∂à</button>
                <button class="btn btn-main" onclick="confirmAddStudent()">Á¢∫Ë™ç</button>
            </div>
        </div>
    </div>

    <script>
        // --- Êú¨Âú∞Â≠òÂÑ≤Ë®≠ÂÆö ---
        const SAVE_KEY = 'dashboard_v0113_2_layout';

        function saveToLocal() {
            // 1. Subjects
            const subjects = [];
            document.querySelectorAll('.subject-item').forEach(item => {
                subjects.push({
                    name: item.querySelector('.subject-input').value,
                    start: item.querySelector('.time-start').value,
                    end: item.querySelector('.time-end').value
                });
            });

            // 2. Attendance
            const attInputs = document.querySelectorAll('.att-val');
            const attendance = {
                expected: attInputs[0].value,
                actual: attInputs[1].value,
                missing: attInputs[2].value
            };

            // 3. View Settings
            const settings = {
                isStudentView: document.getElementById('viewToggle').checked,
                isRightStart: document.getElementById('dirToggle').checked
            };

            // 4. Grid Layout (Capture explicit structure)
            const gridLayout = getGridFromDOM().map(col => ({
                label: col.label,
                seats: col.seats.map(seat => {
                    if (!seat) return null; // Empty
                    return { id: seat.id, name: seat.name };
                })
            }));

            const data = {
                students: students,
                subjects: subjects,
                attendance: attendance,
                settings: settings,
                grid: gridLayout
            };

            localStorage.setItem(SAVE_KEY, JSON.stringify(data));
        }

        function loadFromLocal() {
            const raw = localStorage.getItem(SAVE_KEY);
            if (raw) {
                try {
                    const data = JSON.parse(raw);
                    
                    // 1. Restore Grid Layout (Prioritize explicit grid)
                    if (data.grid && Array.isArray(data.grid)) {
                        // Reconstruct grid structure exactly as saved
                        // Note: View Toggle state will handle the rotation visual separately
                        renderGridToDOM(data.grid);
                        updateStudentsFromDOM(); // Sync global students variable
                    } else if (data.students) {
                        // Legacy support
                        students = data.students;
                        refillSeating(students);
                    } else {
                        generateSeatingInitial();
                    }

                    // 2. Restore Subjects
                    if (data.subjects && Array.isArray(data.subjects)) {
                        const list = document.getElementById('subjectList');
                        const existing = list.querySelectorAll('.subject-item');
                        existing.forEach(el => el.remove());
                        const addBtn = document.getElementById('addSubjectBtn');
                        
                        data.subjects.forEach(sub => {
                            const d = document.createElement('div');
                            d.className = 'subject-item';
                            d.innerHTML = `<div class="subject-header"><input type="text" class="subject-input" value="${sub.name}" onfocus="handleFocus(this)"><button class="btn-delete" onclick="removeSubject(this)">√ó</button></div><div class="time-inputs"><input type="text" class="time-input time-start" placeholder="HH:mm" maxlength="5" onfocus="handleFocus(this)" onblur="formatTimeInput(this)" value="${sub.start}"><span class="time-sep">~</span><input type="text" class="time-input time-end" placeholder="HH:mm" maxlength="5" onfocus="handleFocus(this)" onblur="formatTimeInput(this)" value="${sub.end}"></div>`;
                            list.insertBefore(d, addBtn);
                        });
                    }

                    // 3. Restore Attendance
                    if (data.attendance) {
                        const attInputs = document.querySelectorAll('.att-val');
                        if (attInputs[0]) attInputs[0].value = data.attendance.expected;
                        if (attInputs[1]) attInputs[1].value = data.attendance.actual;
                        if (attInputs[2]) attInputs[2].value = data.attendance.missing;
                    }

                    // 4. Restore Settings
                    if (data.settings) {
                        const vToggle = document.getElementById('viewToggle');
                        const dToggle = document.getElementById('dirToggle');
                        
                        if (vToggle.checked !== data.settings.isStudentView) vToggle.checked = data.settings.isStudentView;
                        if (dToggle.checked !== data.settings.isRightStart) dToggle.checked = data.settings.isRightStart;
                        
                        // Apply CSS class for view
                        if(data.settings.isStudentView) {
                            document.getElementById('seatingContainer').classList.add('student-view');
                        }
                        updateColumnLabels();
                    }
                } catch(e) {
                    console.error("Load error:", e);
                    generateSeatingInitial();
                }
            } else {
                generateSeatingInitial();
            }
        }

        // Auto-save trigger
        let saveTimer = null;
        function triggerSave() {
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(saveToLocal, 1000); 
        }

        window.addEventListener('load', loadFromLocal);
        document.body.addEventListener('input', triggerSave);

        // --- Fullscreen ---
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch((e) => {
                    console.log("Fullscreen blocked:", e);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // --- Focus & Input Handling ---
        let focusTimer = null;
        function handleFocus(el) {
            if (focusTimer) clearTimeout(focusTimer);
            const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            const delay = isTouch ? 400 : 50;

            focusTimer = setTimeout(() => {
                if (document.activeElement !== el) return;
                if (el.tagName.toLowerCase() !== 'textarea') {
                    el.select();
                }
                el.scrollIntoView({
                    behavior: isTouch ? 'auto' : 'smooth', 
                    block: 'center'
                });
                focusTimer = null;
            }, delay); 
        }

        function updateFlipUnit(elementId, newValue) {
            const unit = document.getElementById(elementId);
            if (!unit) return;
            const topSpan = unit.querySelector('.flip-top span');
            const bottomSpan = unit.querySelector('.flip-bottom span');
            const currentVal = topSpan.innerText;
            const nextVal = String(newValue).padStart(2, '0');
            if (currentVal === nextVal) return;

            const frontLeaf = document.createElement('div');
            frontLeaf.className = 'flip-leaf-front';
            frontLeaf.innerHTML = `<span>${currentVal}</span>`;
            
            const backLeaf = document.createElement('div');
            backLeaf.className = 'flip-leaf-back';
            backLeaf.innerHTML = `<span>${nextVal}</span>`;
            
            topSpan.innerText = nextVal;
            bottomSpan.innerText = currentVal; 

            unit.appendChild(frontLeaf);
            unit.appendChild(backLeaf);
            
            unit.classList.add('flipping');

            setTimeout(() => {
                bottomSpan.innerText = nextVal;
                frontLeaf.remove();
                backLeaf.remove();
                unit.classList.remove('flipping');
            }, 350); 
        }

        const viewToggle = document.getElementById('viewToggle');
        const dirToggle = document.getElementById('dirToggle');
        const seatingContainer = document.getElementById('seatingContainer');
        const classroomLayout = document.getElementById('classroomLayout');

        function setView(isStudent) {
            if (viewToggle.checked === isStudent) return;
            viewToggle.checked = isStudent;
            dirToggle.checked = !dirToggle.checked;
            
            if (document.startViewTransition) {
                 document.startViewTransition(() => triggerViewChangeLogic());
            } else {
                 triggerViewChangeLogic();
            }
            triggerSave();
        }

        function setDirection(isRight) {
            if (dirToggle.checked === isRight) return;
            dirToggle.checked = isRight;
            updateColumnLabels();
            triggerSave();
        }

        viewToggle.addEventListener('change', () => {
            dirToggle.checked = !dirToggle.checked;
            if (document.startViewTransition) {
                 document.startViewTransition(() => triggerViewChangeLogic());
            } else {
                 triggerViewChangeLogic();
            }
            triggerSave();
        });

        dirToggle.addEventListener('change', () => {
            updateColumnLabels();
            triggerSave();
        });

        function getGridFromDOM() {
            const cols = Array.from(document.querySelectorAll('.seat-column'));
            // Captures structured grid including explicit empty seats and labels
            return cols.map(colEl => {
                const rowEls = Array.from(colEl.querySelectorAll('.seat-box'));
                const labelVal = colEl.querySelector('.col-label-input').value;
                return {
                    label: labelVal,
                    seats: rowEls.map(seat => {
                        if (seat.classList.contains('empty')) return null;
                        const num = seat.querySelector('.seat-num').innerText;
                        const name = seat.querySelector('.seat-name').innerText;
                        return { id: num, name: name };
                    })
                };
            });
        }

        function rotateGrid180(grid) {
            if (!grid.length) return [];
            // FIX: Deep copy to prevent data pollution
            const newGrid = grid.map(col => ({
                ...col,
                seats: [...col.seats].reverse()
            })).reverse();
            return newGrid;
        }

        function renderGridToDOM(grid) {
            const container = document.getElementById('classroomLayout');
            container.innerHTML = '';
            
            grid.forEach((colData, idx) => {
                const div = document.createElement('div');
                div.className = 'seat-column';
                
                colData.seats.forEach(seat => {
                    if (seat) {
                        const s = createSeat(seat.id, seat.name);
                        div.appendChild(s);
                    } else {
                        const s = createSeat('', '');
                        convertToEmpty(s);
                        div.appendChild(s);
                    }
                });
                
                const inp = document.createElement('input'); 
                inp.className = 'col-label-input'; 
                // Restore label if saved
                if (colData.label) inp.value = colData.label; 
                div.appendChild(inp);
                container.appendChild(div);
            });
        }

        function triggerViewChangeLogic() {
            const isStudent = viewToggle.checked;
            // Get current displayed grid
            const currentGrid = getGridFromDOM();
            
            if (isStudent) {
                seatingContainer.classList.add('student-view');
            } else {
                seatingContainer.classList.remove('student-view');
            }
            
            const newGrid = rotateGrid180(currentGrid);
            renderGridToDOM(newGrid);
            updateColumnLabels(); 
        }

        function updateColumnLabels() {
            const cols = document.querySelectorAll('.seat-column');
            const total = cols.length;
            const isRightStart = dirToggle.checked; 

            cols.forEach((col, index) => {
                const inp = col.querySelector('.col-label-input');
                // Only auto-update if it looks like default (to allow custom labels)
                // For simplicity in this version, we enforce auto-labels on toggle change
                let labelNum;
                if (isRightStart) {
                    labelNum = total - index;
                } else {
                    labelNum = index + 1;
                }
                inp.value = `Á¨¨${labelNum}Êéí`;
            });
        }

        function initResizable() {
            const setupResizer = (resizerId, targetId, direction, isBottomAnchor = false) => {
                const resizer = document.getElementById(resizerId);
                const target = document.getElementById(targetId);
                if (!resizer || !target) return;

                let startPos = 0, startSize = 0;

                const onStart = (e) => {
                    startPos = direction === 'width' ? (e.type.includes('touch')?e.touches[0].clientX:e.clientX) : (e.type.includes('touch')?e.touches[0].clientY:e.clientY);
                    const rect = target.getBoundingClientRect();
                    startSize = direction === 'width' ? rect.width : rect.height;
                    
                    if (direction === 'width') {
                        target.style.width = startSize + 'px';
                    } else {
                        target.style.height = startSize + 'px';
                    }

                    target.style.flex = 'none';

                    document.body.classList.add('is-resizing');
                    if(direction !== 'width') document.body.classList.add('row-resize');
                    window.addEventListener('mousemove', onMove); window.addEventListener('touchmove', onMove, {passive:false});
                    window.addEventListener('mouseup', onEnd); window.addEventListener('touchend', onEnd);
                };
                const onMove = (e) => {
                    if (e.type === 'touchmove') e.preventDefault();
                    let curr = direction === 'width' ? (e.type.includes('touch')?e.touches[0].clientX:e.clientX) : (e.type.includes('touch')?e.touches[0].clientY:e.clientY);
                    let newSize = isBottomAnchor ? startSize + (startPos - curr) : startSize + (curr - startPos);
                    
                    if (newSize > 40) { 
                        if (direction === 'width') {
                            const parentWidth = target.parentElement.clientWidth;
                            const maxWidth = parentWidth - 220; 
                            if (newSize > maxWidth) newSize = maxWidth;
                            
                            target.style.width = newSize+'px';
                        } else { 
                            target.style.height = newSize+'px'; 
                        }
                    }
                };
                const onEnd = () => {
                    document.body.classList.remove('is-resizing'); document.body.classList.remove('row-resize');
                    window.removeEventListener('mousemove', onMove); window.removeEventListener('touchmove', onMove);
                    window.removeEventListener('mouseup', onEnd); window.removeEventListener('touchend', onEnd);
                };
                resizer.addEventListener('mousedown', onStart); resizer.addEventListener('touchstart', onStart, {passive:false});
            };
            setupResizer('resizerHeader', 'clockCard', 'width');   
            setupResizer('resizerMain', 'headerRow', 'height');    
            setupResizer('resizerContent', 'scheduleCol', 'width'); 
            setupResizer('resizerSubjectSplit', 'attendanceCard', 'height', true);
        }
        window.addEventListener('DOMContentLoaded', initResizable);

        const headerRow = document.getElementById('headerRow');
        const headerObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                if (entry.contentRect.height < 150) {
                    headerRow.classList.add('compact');
                } else {
                    headerRow.classList.remove('compact');
                }
            }
        });
        headerObserver.observe(headerRow);

        const attCard = document.getElementById('attendanceCard');
        const attObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                if (entry.contentRect.height < 140) {
                    attCard.classList.add('compact');
                } else {
                    attCard.classList.remove('compact');
                }
            }
        });
        attObserver.observe(attCard);


        let dragItem=null, ghostItem=null, dragStartX=0, dragStartY=0;
        function enableDragAndDrop(seat) { seat.addEventListener('mousedown', handleDragStart); seat.addEventListener('touchstart', handleDragStart, {passive:false}); }
        function handleDragStart(e) {
            if(e.target.classList.contains('seat-close') || (e.type==='mousedown'&&e.button!==0)) return;
            if(this.classList.contains('empty')) return;
            
            e.preventDefault(); dragItem=this;
            dragStartX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            dragStartY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            ghostItem = this.cloneNode(true); ghostItem.classList.add('seat-ghost');
            const r = this.getBoundingClientRect();
            ghostItem.style.width=r.width+'px'; ghostItem.style.height=r.height+'px';
            ghostItem.style.left=r.left+'px'; ghostItem.style.top=r.top+'px';
            document.body.appendChild(ghostItem); this.style.opacity='0.5';
            window.addEventListener('mousemove', handleDragMove); window.addEventListener('touchmove', handleDragMove, {passive:false});
            window.addEventListener('mouseup', handleDragEnd); window.addEventListener('touchend', handleDragEnd);
        }
        function handleDragMove(e) {
            if(!dragItem||!ghostItem) return; e.preventDefault();
            const cx = e.type.includes('touch')?e.touches[0].clientX:e.clientX;
            const cy = e.type.includes('touch')?e.touches[0].clientY:e.clientY;
            ghostItem.style.left = (ghostItem.offsetLeft + (cx - dragStartX)) + 'px';
            ghostItem.style.top = (ghostItem.offsetTop + (cy - dragStartY)) + 'px';
            dragStartX=cx; dragStartY=cy;
            document.querySelectorAll('.seat-box').forEach(b=>b.classList.remove('drag-over'));
            let t = document.elementFromPoint(cx, cy);
            if(t && t.closest('.seat-box') && t.closest('.seat-box')!==dragItem) t.closest('.seat-box').classList.add('drag-over');
        }
        function handleDragEnd(e) {
            if(!dragItem) return;
            const cx = e.type.includes('touch')?e.changedTouches[0].clientX:e.clientX;
            const cy = e.type.includes('touch')?e.changedTouches[0].clientY:e.clientY;
            if(ghostItem) { ghostItem.remove(); ghostItem=null; }
            dragItem.style.opacity='1';
            document.querySelectorAll('.seat-box').forEach(b=>b.classList.remove('drag-over'));
            let t = document.elementFromPoint(cx, cy);
            if(t) {
                t = t.closest('.seat-box');
                if(t && t!==dragItem) {
                    const srcH=dragItem.innerHTML, srcC=dragItem.className;
                    const srcV=dragItem.style.viewTransitionName; 
                    const tgtV=t.style.viewTransitionName;

                    dragItem.innerHTML=t.innerHTML; dragItem.className=t.className;
                    dragItem.style.viewTransitionName = tgtV;

                    t.innerHTML=srcH; t.className=srcC;
                    t.style.viewTransitionName = srcV;

                    updateStudentsFromDOM();
                    triggerSave();
                }
            }
            dragItem=null;
            window.removeEventListener('mousemove', handleDragMove); window.removeEventListener('touchmove', handleDragMove);
            window.removeEventListener('mouseup', handleDragEnd); window.removeEventListener('touchend', handleDragEnd);
        }

        function formatTimeInput(i){ 
            let v=i.value.replace(/[^0-9:]/g,''); 
            if(!v)return;
            if(!v.includes(':')){ if(v.length===4) v=v.slice(0,2)+':'+v.slice(2); else if(v.length<=2) v=v.padStart(2,'0')+':00'; }
            let p=v.split(':'), h=parseInt(p[0]||0), m=parseInt(p[1]||0);
            if(h>23)h=23; if(m>59)m=59;
            i.value=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');
            triggerSave();
        }

        let timeOffset=0;
        function updateClock(){
            const now = new Date(Date.now()+timeOffset);
            const days=['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'];
            document.getElementById('clockDate').textContent = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ÊòüÊúü${days[now.getDay()]}`;
            updateFlipUnit('flipH', now.getHours());
            updateFlipUnit('flipM', now.getMinutes());
            checkSchedule(now);
        }
        function checkSchedule(now){
            const subs=document.querySelectorAll('.subject-item');
            const stTxt=document.getElementById('statusText');
            const rmTime=document.getElementById('remainingTime');
            const prog=document.getElementById('progressFill');
            const card=document.getElementById('statusCard');
            subs.forEach(e=>e.classList.remove('active'));
            
            const nSec = now.getHours()*3600+now.getMinutes()*60+now.getSeconds();
            let act=null, nxt=null, minD=Infinity;
            
            subs.forEach(e=>{
                const s=e.querySelector('.time-start').value, en=e.querySelector('.time-end').value;
                if(!s||!en||!s.includes(':')||!en.includes(':'))return;
                const [sh,sm]=s.split(':').map(Number), [eh,em]=en.split(':').map(Number);
                const sSec=sh*3600+sm*60, eSec=eh*3600+em*60;
                if(nSec>=sSec && nSec<eSec) act={el:e,name:e.querySelector('.subject-input').value,end:eSec,tot:eSec-sSec};
                else if(nSec<sSec) { const d=sSec-nSec; if(d<minD){ minD=d; nxt={name:e.querySelector('.subject-input').value,diff:d};}}
            });

            if(act){
                act.el.classList.add('active');
                const r=act.end-nSec;
                rmTime.textContent=fmt(r); stTxt.textContent=`${act.name} ËÄÉË©¶‰∏≠`;
                prog.style.width=((act.tot-r)/act.tot*100)+'%';
                if(r<300) card.classList.add('urgent'); else card.classList.remove('urgent');
            } else if(nxt){
                rmTime.textContent="--:--"; stTxt.innerHTML=`Ë∑ùÈõ¢ ${nxt.name} ÈÇÑÊúâ ${fmt(nxt.diff)}`;
                card.classList.remove('urgent'); prog.style.width='0%';
            } else {
                rmTime.textContent="‰ºëÊÅØ"; stTxt.textContent="ÁõÆÂâçÁÑ°ËÄÉË©¶";
                card.classList.remove('urgent'); prog.style.width='0%';
            }
        }
        function fmt(s){ return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0'); }

        function addSubject(){
            const d=document.createElement('div'); 
            d.className='subject-item';
            d.innerHTML=`<div class="subject-header"><input type="text" class="subject-input" value="Êñ∞ÁßëÁõÆ" onfocus="handleFocus(this)"><button class="btn-delete" onclick="removeSubject(this)">√ó</button></div><div class="time-inputs"><input type="text" class="time-input time-start" placeholder="HH:mm" maxlength="5" onfocus="handleFocus(this)" onblur="formatTimeInput(this)"><span class="time-sep">~</span><input type="text" class="time-input time-end" placeholder="HH:mm" maxlength="5" onfocus="handleFocus(this)" onblur="formatTimeInput(this)"></div>`;
            document.getElementById('subjectList').insertBefore(d, document.getElementById('addSubjectBtn'));
            
            const inp = d.querySelector('.subject-input');
            if(inp) {
                inp.focus();
                setTimeout(() => {
                    inp.select();
                }, 10);
            }
            triggerSave();
        }
        function removeSubject(b){ 
            b.closest('.subject-item').remove(); 
            triggerSave();
        }
        
        let students=[{id:"1",name:"ÁéãÂ¶çÂøÉ"},{id:"2",name:"ÊùéÂ§ßËèØ"},{id:"3",name:"ÂºµÂ∞èÊòé"},{id:"4",name:"Èô≥ÈòøÂØ∂"},{id:"5",name:"ÊûóÂøóË±™"},{id:"6",name:"Ë®±ÂÆ∂Ë±™"},{id:"7",name:"Âê≥ÈõÖÂ©∑"},{id:"8",name:"Ëî°Ê¨£ÊÄ°"}];
        
        function createSeat(n,nm){
            const s=document.createElement('div'); s.className='seat-box';
            s.innerHTML=`<div class="seat-close" onclick="deleteSeat(event,this)">√ó</div><div class="seat-num">${n}</div><div class="seat-name">${nm}</div>`;
            s.onclick=function(){ if(this.classList.contains('empty')) addNewStudent(this); };
            
            if(n) {
                s.style.viewTransitionName = 'seat-' + n;
            } else if (nm) {
                const safeName = btoa(encodeURIComponent(nm)).replace(/[^a-zA-Z0-9]/g, '');
                s.style.viewTransitionName = 'seat-name-' + safeName + '-' + Math.floor(Math.random()*10000);
            }
            enableDragAndDrop(s); return s;
        }
        function convertToEmpty(el){ 
            el.className='seat-box empty'; 
            el.innerHTML='<div class="add-sign">+</div>'; 
            el.style.viewTransitionName = ''; 
            updateStudentsFromDOM(); 
            triggerSave();
        }
        
        let targetSeatElement = null; 

        function addNewStudent(el){
            targetSeatElement = el; 
            const modal = document.getElementById('singleStudentModal');
            document.getElementById('newStudentId').value = ''; 
            document.getElementById('newStudentName').value = ''; 
            modal.style.display = 'flex';
            
            setTimeout(() => {
                const idInput = document.getElementById('newStudentId');
                idInput.focus();
            }, 300);
        }

        function closeSingleStudentModal() {
            document.getElementById('singleStudentModal').style.display = 'none';
            targetSeatElement = null;
        }

        function confirmAddStudent() {
            if (!targetSeatElement) return;
            const n = document.getElementById('newStudentId').value.trim();
            const nm = document.getElementById('newStudentName').value.trim();
            
            if (!nm) {
                alert("Ë´ãËº∏ÂÖ•ÂßìÂêçÔºÅ");
                return;
            }

            targetSeatElement.className = 'seat-box';
            targetSeatElement.innerHTML = `<div class="seat-close" onclick="deleteSeat(event,this)">√ó</div><div class="seat-num">${n}</div><div class="seat-name">${nm}</div>`;
            
            if (n) {
                targetSeatElement.style.viewTransitionName = 'seat-' + n;
            } else {
                const safeName = btoa(encodeURIComponent(nm)).replace(/[^a-zA-Z0-9]/g, '');
                targetSeatElement.style.viewTransitionName = 'seat-name-' + safeName + '-' + Math.floor(Math.random()*10000);
            }
            
            updateStudentsFromDOM();
            closeSingleStudentModal();
            triggerSave();
        }

        document.getElementById('newStudentId').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') document.getElementById('newStudentName').focus();
        });
        document.getElementById('newStudentName').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') confirmAddStudent();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('modal');
                const singleModal = document.getElementById('singleStudentModal');
                if (modal.style.display === 'flex') closeModal();
                if (singleModal.style.display === 'flex') closeSingleStudentModal();
            }
        });
        
        ['modal', 'singleStudentModal'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('click', function(e) {
                    if (e.target === this) {
                        if(id === 'modal') closeModal();
                        else closeSingleStudentModal();
                    }
                });
            }
        });

        window.deleteSeat = function(e, b) { 
            e.stopPropagation(); 
            convertToEmpty(b.parentElement);
        }

        function updateStudentsFromDOM(){
            const tmp=[]; document.querySelectorAll('.seat-column').forEach(c=>{
                c.querySelectorAll('.seat-box:not(.empty)').forEach(s=>{ tmp.push({id:s.querySelector('.seat-num').innerText, name:s.querySelector('.seat-name').innerText}); });
            });
            if(tmp.length) students=tmp;
        }
        window.addColumn=function(){
            const c=document.getElementById('classroomLayout'), cols=document.querySelectorAll('.seat-column');
            let max=6; cols.forEach(x=>max=Math.max(max, x.querySelectorAll('.seat-box').length));
            const div=document.createElement('div'); div.className='seat-column';
            for(let i=0;i<max;i++){ const s=createSeat('',''); convertToEmpty(s); div.appendChild(s); }
            const inp=document.createElement('input'); inp.className='col-label-input';
            div.appendChild(inp);
            c.appendChild(div);
            updateColumnLabels();
            triggerSave();
        }
        window.removeColumn=function(){ const c=document.getElementById('classroomLayout'); if(c.children.length) {c.lastElementChild.remove(); updateStudentsFromDOM(); updateColumnLabels(); triggerSave();} }
        window.addRow=function(){ document.querySelectorAll('.seat-column').forEach(c=>{ const s=createSeat('',''); convertToEmpty(s); c.insertBefore(s, c.querySelector('.col-label-input')); }); triggerSave(); }
        window.removeRow=function(){ document.querySelectorAll('.seat-column').forEach(c=>{ const s=c.querySelectorAll('.seat-box'); if(s.length) {s[s.length-1].remove(); updateStudentsFromDOM();} }); triggerSave(); }
        
        function reshuffleSeating(){
            const s=document.querySelectorAll('.seat-box:not(.empty)');
            let pool=[]; s.forEach(x=>pool.push({id:x.querySelector('.seat-num').innerText,name:x.querySelector('.seat-name').innerText}));
            if(!pool.length)return;
            for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
            
            const doShuffle = () => {
                s.forEach((x,i)=>{ 
                    x.innerHTML=`<div class="seat-close" onclick="deleteSeat(event,this)">√ó</div><div class="seat-num">${pool[i].id}</div><div class="seat-name">${pool[i].name}</div>`;
                    
                    if (pool[i].id) {
                        x.style.viewTransitionName = 'seat-' + pool[i].id;
                    } else {
                        const safeName = btoa(encodeURIComponent(pool[i].name)).replace(/[^a-zA-Z0-9]/g, '');
                        x.style.viewTransitionName = 'seat-name-' + safeName + '-' + Math.floor(Math.random()*10000);
                    }
                });
                students=pool;
            };

            if (document.startViewTransition) {
                document.startViewTransition(doShuffle);
            } else {
                doShuffle();
            }
            triggerSave();
        }

        function refillSeating(arr){
            // ÈáçÊäì cols Á¢∫‰øù reference Ê≠£Á¢∫
            let cols=document.querySelectorAll('.seat-column');
            
            if(!cols.length){ students=arr; generateSeatingInitial(); return; }
            
            let pool=[...arr];
            for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
            
            let total=0; 
            cols.forEach(c=>total+=c.querySelectorAll('.seat-box').length);
            
            while(total<pool.length){ 
                addColumn(); 
                cols=document.querySelectorAll('.seat-column'); 
                total=0; 
                cols.forEach(c=>total+=c.querySelectorAll('.seat-box').length); 
            }
            
            const doRefill = () => {
                let idx=0;
                // Âú®Âü∑Ë°åÁï∂‰∏ãÈáçÊñ∞Áç≤Âèñ DOM
                const currentCols = document.querySelectorAll('.seat-column');
                currentCols.forEach(c=>{ c.querySelectorAll('.seat-box').forEach(s=>{
                    if(idx<pool.length){ 
                        const p=pool[idx++]; s.className='seat-box'; 
                        s.innerHTML=`<div class="seat-close" onclick="deleteSeat(event,this)">√ó</div><div class="seat-num">${p.id}</div><div class="seat-name">${p.name}</div>`; 
                        
                        if (p.id) {
                            s.style.viewTransitionName = 'seat-' + p.id;
                        } else {
                            const safeName = btoa(encodeURIComponent(p.name)).replace(/[^a-zA-Z0-9]/g, '');
                            s.style.viewTransitionName = 'seat-name-' + safeName + '-' + Math.floor(Math.random()*10000);
                        }
                    }
                    else convertToEmpty(s);
                })});
                students=pool;
            };

            if(document.startViewTransition) {
                document.startViewTransition(doRefill);
            } else {
                doRefill();
            }
            triggerSave();
        }
        function generateSeatingInitial(){
            const c=document.getElementById('classroomLayout'); c.innerHTML='';
            let pool=[...students];
            for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
            let idx=0;
            for(let i=0;i<7;i++){
                const col=document.createElement('div'); col.className='seat-column';
                for(let r=0;r<6;r++){
                    if(idx<pool.length){ 
                        const p=pool[idx++]; 
                        const s = createSeat(p.id,p.name);
                        col.appendChild(s); 
                    }
                    else { const s=createSeat('',''); convertToEmpty(s); col.appendChild(s); }
                }
                const inp=document.createElement('input'); inp.className='col-label-input';
                col.appendChild(inp);
                c.appendChild(col);
            }
            updateColumnLabels();
        }
        
        function openModal(){ 
            const modal = document.getElementById('modal');
            const textarea = document.getElementById('studentListInput');
            modal.style.display='flex'; 
            textarea.value = students.map(s => s.id ? `${s.id} ${s.name}` : s.name).join('\n');
            setTimeout(() => {
                textarea.focus();
                textarea.setSelectionRange(0, textarea.value.length);
                textarea.scrollTop = 0;
            }, 300); 
        }
        
        function closeModal(){ 
            const modal = document.getElementById('modal');
            modal.style.display='none'; 
        }
        
        function saveStudents(){
            const val=document.getElementById('studentListInput').value;
            const arr=val.split('\n').map(x=>{ 
                x=x.trim(); 
                if(!x) return null; 
                const match = x.match(/^(\d+)[\s\.\,\„ÄÅ\t]+(.+)$/);
                if (match) {
                    return { id: match[1], name: match[2].trim() };
                } else {
                    return { id: "", name: x };
                }
            }).filter(x=>x);

            if(arr.length){ refillSeating(arr); closeModal(); triggerSave(); } else alert("ÂêçÂñÆÁÇ∫Á©∫");
        }

        setInterval(updateClock, 1000);
        updateClock();
        // ÂàùÂßãÂåñËºâÂÖ•‰∫§Áî± loadFromLocal ËôïÁêÜÔºåÈÅøÂÖçË¶ÜËìã
        // generateSeatingInitial(); 
    </script>
</body>
</html>
